import{s as r}from"./darkMode-B-Ivf8oh.js";document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:f}}=await r.auth.getSession();if(!f||!f.user){window.location.href="Login.html";return}const C=document.getElementById("adminComplaintForm"),s=document.getElementById("description"),d=document.getElementById("previousAttempts"),c=document.getElementById("fileDesc"),g=document.getElementById("staffInvolved"),$=document.getElementById("declaration"),A=document.getElementById("adminType"),b=document.getElementById("descCounter"),B=document.getElementById("attemptCounter"),D=document.getElementById("fileCounter");function m(t){return t.trim().split(/\s+/).filter(Boolean).length}function v(t,e,i){t.addEventListener("input",()=>{let n=m(t.value);if(n>i){const o=t.value.split(/\s+/).slice(0,i).join(" ");t.value=o,n=i}e.textContent=`${n} / ${i} words`})}const u=document.getElementById("file"),y=document.getElementById("imagePreview");u.addEventListener("change",()=>{y.innerHTML="",u.files&&Array.from(u.files).forEach(t=>{if(t.type.startsWith("image/")){const e=new FileReader;e.onload=i=>{const n=document.createElement("div");n.classList.add("relative","w-24","h-24");const o=document.createElement("img");o.src=i.target.result,o.classList.add("w-full","h-full","object-cover","rounded-lg","border","border-gray-200","shadow-sm");const a=document.createElement("button");a.innerHTML='<i class="fas fa-times"></i>',a.classList.add("absolute","-top-2","-right-2","bg-red-500","text-white","rounded-full","w-6","h-6","flex","items-center","justify-center","text-xs","hover:bg-red-600","shadow-md"),a.onclick=p=>{p.preventDefault(),u.value="",y.innerHTML=""},n.appendChild(o),n.appendChild(a),y.appendChild(n)},e.readAsDataURL(t)}})}),v(s,b,500),v(d,B,100),v(c,D,100),[s,d,c].forEach(t=>{t&&t.dispatchEvent(new Event("input"))});let h=f;if(!h||!h.user){window.location.href="Login.html";return}const x=h.user.id;C.addEventListener("submit",async t=>{t.preventDefault();let e=[];const i=document.getElementById("complaintTitle").value.trim();if(i?/^[A-Za-z0-9\s]+$/.test(i)||e.push("Complaint title can only contain letters, numbers, and spaces."):e.push("Complaint title is required."),A.value||e.push("Please select a Type of Administration."),s.value.trim()||e.push("Description is required."),$.checked||e.push("You must declare that the information provided is accurate."),g.value.trim()&&!/^[a-zA-Z0-9\s]+$/.test(g.value)&&e.push("Staff Involved can only contain letters, numbers, and spaces."),m(s.value)>500&&e.push("Description cannot exceed 500 words."),m(d.value)>100&&e.push("Previous attempts cannot exceed 100 words."),m(c.value)>100&&e.push("File description cannot exceed 100 words."),e.length>0){alert(e.join(`
`));return}try{const{data:n,error:o}=await r.from("admin").select("id").eq("adminrole","Administrative Admin").single();if(o||!n){console.error("Error fetching Administrative Admin:",o),alert("System Error: Could not find Administrative Admin. Please contact support.");return}const a=n.id,{data:p,error:L}=await r.from("category").select("categoryid").eq("categoryname","Administrative").single();if(L||!p){console.error("Error fetching Administrative category:",L),alert("System Error: Could not find Administrative category. Please contact support.");return}const _=p.categoryid,{data:j,error:P}=await r.from("complaint").insert([{complainantid:x,adminid:a,categoryid:_,submitteddate:new Date().toISOString(),dateofincident:new Date().toISOString(),complainttitle:i,complaintdescription:s.value.trim(),complaintstatus:"Pending"}]).select().single();if(P){console.error("Complaint insert error:",P),alert("Failed to submit complaint. Please try again.");return}const w=j.complaintid,{error:S}=await r.from("administrativecomplaint").insert([{complaintid:w,complaintdepartment:A.value,staffinvolved:g.value.trim()||null,previousattempts:d.value.trim()||null,desiredoutcome:document.getElementById("desiredOutcome").value.trim()||null}]);if(S){console.error("Administrative complaint insert error:",S),alert("Failed to save administrative complaint. Please try again.");return}const E=document.getElementById("file"),q=c.value.trim();if(E.files.length>0)for(let l=0;l<E.files.length;l++){const I=E.files[l],M=`${Date.now()}_${I.name}`,{data:O,error:F}=await r.storage.from("user-uploads").upload(M,I);if(F){console.error("File upload error:",F),alert("File upload failed. Please try again.");return}const{data:U}=r.storage.from("user-uploads").getPublicUrl(O.path),H=U.publicUrl,{error:T}=await r.from("complaintattachment").insert([{complaintid:w,fileurl:H,description:q,filename:I.name}]);if(T){console.error("Attachment insert error:",T),alert("Failed to save file info. Please try again.");return}}try{await r.from("admin_notifications").insert([{admin_id:a,complaint_id:w,type:"New Complaint",message:`New Administrative complaint submitted: "${i}"`,is_read:!1}])}catch(l){console.error("Failed to create admin notification:",l)}C.reset(),b.textContent="0 / 500 words",B.textContent="0 / 100 words",D.textContent="0 / 100 words",alert("Administrative complaint submitted successfully!")}catch(n){console.error(n),alert("Something went wrong. Please try again.")}})});
