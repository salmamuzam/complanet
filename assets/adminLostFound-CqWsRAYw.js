import{s as f}from"./darkMode-B-Ivf8oh.js";document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:G}}=await f.auth.getSession();if(!G){window.location.href="Login.html";return}const{data:N}=await f.from("admin").select("id, adminrole, profile_pic").eq("id",G.user.id).single();if(!N){window.location.href="Login.html";return}const K=document.getElementById("profileButton");K&&N.profile_pic&&(K.innerHTML=`
            <img src="${N.profile_pic}" alt="Profile" class="h-10 w-10 rounded-full object-cover">
        `);const v=document.getElementById("itemsTableBody"),A=document.getElementById("itemsCardsView"),ue=document.getElementById("itemCardTemplate");document.getElementById("statusFilter");const me=document.getElementById("itemRowTemplate"),X=document.getElementById("emptyTableStateTemplate"),ee=document.getElementById("emptyCardStateTemplate");document.getElementById("errorTableStateTemplate");let k=[],_=[],i=1;const R=10;let I="all",d={source:"all",categories:[],statuses:[],dateFrom:null,dateTo:null};Ie();const $=document.getElementById("tabAllRequests"),U=document.getElementById("tabLostItems"),H=document.getElementById("tabFoundItems"),F=document.getElementById("uploadFoundItemBtn");$.addEventListener("click",()=>B("all")),U.addEventListener("click",()=>B("lost")),H.addEventListener("click",()=>B("found"));function B(e){I=e,i=1,[$,U,H].forEach(n=>n.classList.remove("active")),e==="all"&&$.classList.add("active"),e==="lost"&&U.classList.add("active"),e==="found"&&H.classList.add("active"),d.source=e,document.querySelectorAll(".filter-source-btn").forEach(n=>{n.classList.remove("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300"),n.classList.add("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300")});const a=document.querySelector(`.filter-source-btn[data-source="${e}"]`);a&&(a.classList.remove("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300"),a.classList.add("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300")),e==="found"?F.classList.remove("hidden"):F.classList.add("hidden"),x()}I==="found"&&F.classList.remove("hidden"),F.addEventListener("click",()=>{window.location.href="AdminUploadFoundItem.html"});const D=document.getElementById("filterModal"),T=document.getElementById("filterDrawer"),ge=document.getElementById("openFiltersBtn"),fe=document.getElementById("closeFiltersBtn"),ye=document.getElementById("applyFiltersBtn"),be=document.getElementById("clearFiltersBtn"),P=document.getElementById("filterBadge"),O=document.getElementById("searchInput"),te=document.getElementById("prevPage"),ne=document.getElementById("nextPage"),oe=document.getElementById("paginationNumbers");ge.addEventListener("click",()=>{D.classList.remove("hidden"),setTimeout(()=>{T.classList.remove("scale-95","opacity-0"),T.classList.add("scale-100","opacity-100")},10)}),fe.addEventListener("click",j),D.addEventListener("click",e=>{e.target===D&&j()});function j(){T.classList.remove("scale-100","opacity-100"),T.classList.add("scale-95","opacity-0"),setTimeout(()=>{D.classList.add("hidden")},300)}document.querySelectorAll(".filter-source-btn").forEach(e=>{e.addEventListener("click",()=>{const a=e.dataset.source;document.querySelectorAll(".filter-source-btn").forEach(n=>{n.classList.remove("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300"),n.classList.add("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300")}),e.classList.remove("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300"),e.classList.add("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300"),d.source=a})}),document.querySelector('.filter-source-btn[data-source="all"]').click(),document.querySelectorAll(".filter-category-chip").forEach(e=>{e.addEventListener("click",()=>{const a=e.dataset.category,n=d.categories.indexOf(a);n>-1?(d.categories.splice(n,1),e.classList.remove("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300"),e.classList.add("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300")):(d.categories.push(a),e.classList.remove("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300"),e.classList.add("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300"))}),e.classList.add("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300")}),document.querySelectorAll(".filter-status-chip").forEach(e=>{e.addEventListener("click",()=>{const a=e.dataset.status,n=d.statuses.indexOf(a);n>-1?(d.statuses.splice(n,1),e.classList.remove("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300"),e.classList.add("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300")):(d.statuses.push(a),e.classList.remove("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300"),e.classList.add("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300"))}),e.classList.add("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300")}),document.querySelectorAll(".date-preset-btn").forEach(e=>{e.addEventListener("click",()=>{const a=e.dataset.preset,n=new Date;let o,r;switch(a){case"today":o=r=n;break;case"last7days":r=n,o=new Date(n),o.setDate(n.getDate()-7);break;case"last30days":r=n,o=new Date(n),o.setDate(n.getDate()-30);break;case"thismonth":o=new Date(n.getFullYear(),n.getMonth(),1),r=n;break}const s=c=>{const u=c.getFullYear(),t=String(c.getMonth()+1).padStart(2,"0"),l=String(c.getDate()).padStart(2,"0");return`${u}-${t}-${l}`};document.getElementById("filterModalDateFrom").value=s(o),document.getElementById("filterModalDateTo").value=s(r),document.querySelectorAll(".date-preset-btn").forEach(c=>{c.classList.remove("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300"),c.classList.add("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300")}),e.classList.remove("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300"),e.classList.add("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300")})}),ye.addEventListener("click",()=>{d.dateFrom=document.getElementById("filterModalDateFrom").value,d.dateTo=document.getElementById("filterModalDateTo").value,V(),B(d.source),j()}),be.addEventListener("click",()=>{d={source:"all",categories:[],statuses:[],dateFrom:null,dateTo:null},document.querySelectorAll(".filter-category-chip, .filter-status-chip, .date-preset-btn").forEach(e=>{e.classList.remove("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300"),e.classList.add("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300")}),document.querySelector('.filter-source-btn[data-source="all"]').click(),document.getElementById("filterModalDateFrom").value="",document.getElementById("filterModalDateTo").value="",V(),i=1,x()});function V(){let e=0;d.source!=="all"&&e++,e+=d.categories.length,e+=d.statuses.length,(d.dateFrom||d.dateTo)&&e++,e>0?(P.textContent=e,P.classList.remove("hidden")):P.classList.add("hidden")}O.addEventListener("input",()=>{i=1,x()}),te.addEventListener("click",()=>{i>1&&(i--,x())}),ne.addEventListener("click",()=>{i++,x()}),await W(),await J();const ae=new URLSearchParams(window.location.search),Y=ae.get("tab");Y&&["all","lost","found"].includes(Y)&&B(Y);const re=ae.get("status");if(re){const e=document.querySelector(`.filter-status-chip[data-status="${re}"]`);if(e){const a=e.dataset.for;a&&a!==I&&B(a),e.click(),V(),x()}}async function W(){const{data:e,error:a}=await f.from("lost_and_found").select("*").neq("status","Deleted").order("reported_date",{ascending:!1});if(a){console.error(a),v.innerHTML="";const n=document.getElementById("errorTableStateTemplate");n?v.appendChild(n.content.cloneNode(!0)):v.innerHTML='<tr><td colspan="7" class="text-center py-6 text-red-500">Error loading items</td></tr>';return}k=e,_.length>0&&x()}async function J(){const{data:e,error:a}=await f.from("found_items").select("*").order("created_at",{ascending:!1});if(a){console.error("Error loading found items:",a);return}_=e||[],x()}function pe(e=null){const a=document.getElementById("totalItemsCount"),n=a.parentElement.childNodes[0];let o=0;const r=d.categories.length>0||d.statuses.length>0||d.dateFrom||d.dateTo||O.value.trim()!=="";e!==null?(o=e,r?n.textContent="Results Found: ":n.textContent="Total Items: "):(I==="all"?o=k.length+_.length:I==="lost"?o=k.length:I==="found"&&(o=_.length),n.textContent="Total Items: "),a.innerText=o}function x(){v.innerHTML="",A.innerHTML="";const e=O.value.toLowerCase();let a=[];I==="all"?a=[...k.map(t=>({...t,itemSource:"lost"})),..._.map(t=>({...t,itemSource:"found"}))]:I==="lost"?a=k.map(t=>({...t,itemSource:"lost"})):I==="found"&&(a=_.map(t=>({...t,itemSource:"found"})));let n=a.filter(t=>{const l=d.categories.length===0||d.categories.includes(t.item_type),w=d.statuses.length===0||d.statuses.includes(t.status);let L=!0;if(d.dateFrom||d.dateTo){const y=new Date(t.itemSource==="lost"?t.reported_date:t.created_at);if(y.setHours(0,0,0,0),d.dateFrom){const E=new Date(d.dateFrom);E.setHours(0,0,0,0),y<E&&(L=!1)}if(d.dateTo&&L){const E=new Date(d.dateTo);E.setHours(0,0,0,0),y>E&&(L=!1)}}const C=t.itemSource==="lost"?t.location_lost||"":t.location_found||"",z=t.itemSource==="lost"?t.item_id||"":t.found_item_id||"",q=String(z).toLowerCase().includes(e)||(t.item_name||"").toLowerCase().includes(e)||(t.item_type||"").toLowerCase().includes(e)||(t.description||"").toLowerCase().includes(e)||(t.distinguishing_features||"").toLowerCase().includes(e)||(t.brand||"").toLowerCase().includes(e)||(t.model||"").toLowerCase().includes(e)||(t.serial_number||"").toLowerCase().includes(e)||(t.primary_color||"").toLowerCase().includes(e)||(t.secondary_color||"").toLowerCase().includes(e)||C.toLowerCase().includes(e);return l&&w&&L&&q});const o=n.length,r=Math.ceil(o/R);pe(o),i>r&&(i=r||1),i<1&&(i=1);const s=(i-1)*R,c=Math.min(s+R,o),u=n.slice(s,c);if(document.getElementById("startRange").textContent=o===0?0:s+1,document.getElementById("endRange").textContent=c,document.getElementById("totalEntries").textContent=o,he(r),n.length===0){Le();return}u.forEach(t=>{const l=t.itemSource==="found";t.date_lost&&new Date(t.date_lost).toLocaleDateString();const w=l?t.created_at?new Date(t.created_at).toLocaleDateString():"N/A":t.reported_date?new Date(t.reported_date).toLocaleDateString():"N/A",L=l?t.location_found||"Unknown":t.location_lost||"Unknown",C=t.brand?`Brand: ${t.brand}`:"",z=t.primary_color?`Color: ${t.primary_color}`:"",q=[C,z].filter(Boolean).join(", ")||"-";let y="bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-300",E=t.status||"N/A";l?(t.status==="Unclaimed"&&(y="bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300"),t.status==="Claimed"&&(y="bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300")):(t.status==="Lost"&&(y="bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300"),t.status==="Claim"&&(y="bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300"),t.status==="Found"&&(y="bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300"),t.status==="Deleted"&&(y="bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300"));const h=l?t.found_item_id:t.item_id,m=me.content.cloneNode(!0);m.querySelector(".item-id").textContent=h,m.querySelector(".item-name").textContent=t.item_name;const M=m.querySelector(".item-source");l?(M.textContent="Found Item",M.className="item-source px-2 py-1 rounded-full text-xs font-bold whitespace-nowrap bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300"):(M.textContent="Lost Item",M.className="item-source px-2 py-1 rounded-full text-xs font-bold whitespace-nowrap bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300"),m.querySelector(".item-type").textContent=t.item_type,m.querySelector(".item-location").textContent=L,m.querySelector(".item-date").textContent=w,m.querySelector(".item-attributes").textContent=q;const ie=m.querySelector(".item-status");ie.textContent=E,ie.className=`item-status px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap ${y}`,l?(m.querySelector(".btn-edit").style.display="none",m.querySelector(".btn-delete").style.display="none"):(m.querySelector(".btn-edit").onclick=()=>window.openStatusModal(h,t.status,t.itemSource),m.querySelector(".btn-delete").onclick=()=>window.openDeleteModal(h,t.itemSource)),m.querySelector(".btn-preview").href=l?`AdminFoundItemDetails.html?id=${h}`:`AdminLostFoundDetails.html?id=${h}`,v.appendChild(m);const g=ue.content.cloneNode(!0);g.querySelector(".card-id").textContent=h,g.querySelector(".card-type").textContent=t.item_type,g.querySelector(".card-title").textContent=t.item_name,g.querySelector(".card-location span").textContent=L,g.querySelector(".card-date").textContent=w;const ce=g.querySelector(".card-status");ce.textContent=E,ce.className=`card-status px-2 py-0.5 rounded text-[10px] font-bold uppercase ${y}`,g.querySelector(".card-attr").textContent=q,l?(g.querySelector(".btn-edit").style.display="none",g.querySelector(".btn-delete").style.display="none"):(g.querySelector(".btn-edit").onclick=()=>window.openStatusModal(h,t.status,t.itemSource),g.querySelector(".btn-delete").onclick=()=>window.openDeleteModal(h,t.itemSource)),g.querySelector(".Link-preview").href=l?`AdminFoundItemDetails.html?id=${h}`:`AdminLostFoundDetails.html?id=${h}`,A.appendChild(g)})}function Le(){if(X){const e=X.content.cloneNode(!0);v.appendChild(e)}if(ee){const e=ee.content.cloneNode(!0);A.appendChild(e)}}function he(e){oe.innerHTML="",te.disabled=i===1,ne.disabled=i===e||e===0;let a=[];e<=7?a=Array.from({length:e},(n,o)=>o+1):i<=4?a=[1,2,3,4,5,"...",e]:i>=e-3?a=[1,"...",e-4,e-3,e-2,e-1,e]:a=[1,"...",i-1,i,i+1,"...",e],a.forEach(n=>{const o=document.createElement("button");o.className=`px-3 py-1 border rounded ${n===i?"bg-blue-600 text-white border-blue-600":"hover:bg-gray-100 dark:hover:bg-gray-700 dark:border-gray-600 dark:text-white"}`,n==="..."?(o.textContent="...",o.disabled=!0,o.classList.add("cursor-default","border-none")):(o.textContent=n,o.onclick=()=>{i=n,x()}),oe.appendChild(o)})}const Q=document.getElementById("statusModal"),Z=document.getElementById("deleteModal"),S=document.getElementById("modalStatusSelect"),de=document.getElementById("modalStatusReason"),se=document.getElementById("modalDeleteReason");let b=null,p=null;window.openStatusModal=(e,a,n)=>{b=e,p=n,S.innerHTML="",n==="found"?S.innerHTML=`
                <option value="Unclaimed">Unclaimed</option>
                <option value="Claimed">Claimed</option>
            `:S.innerHTML=`
                <option value="Lost">Lost</option>
                <option value="Claim">Claim (Match)</option>
                <option value="Found">Found (Returned)</option>
            `,S.value=a,de.value="";const o=document.getElementById("foundItemIdContainer"),r=document.getElementById("modalFoundItemId"),s=document.getElementById("foundItemIdError");S.addEventListener("change",function(){this.value==="Found"&&p!=="found"?o.classList.remove("hidden"):(o.classList.add("hidden"),r.value="",s.classList.add("hidden"))}),a==="Found"&&p!=="found"?o.classList.remove("hidden"):(o.classList.add("hidden"),r.value="",s.classList.add("hidden")),Q.classList.remove("hidden")},window.openDeleteModal=(e,a)=>{b=e,p=a,se.value="",Z.classList.remove("hidden")},document.getElementById("cancelStatusBtn").addEventListener("click",()=>Q.classList.add("hidden")),document.getElementById("cancelDeleteBtn").addEventListener("click",()=>Z.classList.add("hidden")),document.getElementById("confirmStatusBtn").addEventListener("click",async()=>{const e=S.value,a=de.value.trim(),n=document.getElementById("modalFoundItemId").value.trim(),o=document.getElementById("foundItemIdError");if(o.classList.add("hidden"),o.textContent="",!a){alert("Please provide a feedback message/reason.");return}if(e==="Found"&&p!=="found"){if(!n){o.textContent="Found Item ID is required when marking as Found.",o.classList.remove("hidden");return}try{const{data:r,error:s}=await f.from("found_items").select("found_item_id, status").eq("found_item_id",n).single();if(s||!r){o.textContent="Found Item ID does not exist in the system.",o.classList.remove("hidden");return}if(r.status!=="Unclaimed"){o.textContent=`This Found Item is already ${r.status}. Please use an Unclaimed item.`,o.classList.remove("hidden");return}}catch(r){console.error("Validation error:",r),o.textContent="Error validating Found Item ID. Please try again.",o.classList.remove("hidden");return}}if(e==="Claim"&&n){o.textContent="Cannot link Found Item ID when status is Claim. Only use Found Item ID for Found status.",o.classList.remove("hidden");return}try{const r=p==="found"?"found_items":"lost_and_found",s=p==="found"?"found_item_id":"item_id",c={status:e,admin_feedback:a};e==="Found"&&n&&p!=="found"&&(c.matched_found_item_id=n);const{error:u}=await f.from(r).update(c).eq(s,b);if(u)throw u;if(e==="Found"&&n&&p!=="found"){const{error:l}=await f.from("found_items").update({status:"Claimed",matched_lost_item_id:b}).eq("found_item_id",n);if(l){console.error("Error updating found item:",l),console.log("Rolling back lost item update...");const w=k.find(C=>C.item_id===b),{error:L}=await f.from("lost_and_found").update({status:w.status,admin_feedback:w.admin_feedback,matched_found_item_id:null}).eq("item_id",b);throw L?(console.error("Rollback failed:",L),alert("CRITICAL ERROR: Update failed and rollback also failed. Please contact system administrator immediately."),new Error("Transaction failed with rollback error")):(alert("Update failed: Could not update found item status. All changes have been rolled back. Please try again or contact support if the issue persists."),new Error("Found item update failed, transaction rolled back"))}}const t=k.find(l=>l.item_id===b);t&&t.user_id&&(await f.from("notifications").insert([{userid:t.user_id,type:"LostItemUpdate",message:`Status updated to ${e}. ${a}`,is_read:!1,lost_item_id:b}]),le(t,e,a)),Q.classList.add("hidden"),await W(),await J(),alert(`Status updated to ${e}`)}catch(r){console.error(r),alert("Failed to update status")}}),document.getElementById("confirmDeleteBtn").addEventListener("click",async()=>{const e=se.value.trim();if(!e){alert("Please provide a reason for deletion.");return}try{const a=p==="found"?"found_items":"lost_and_found",n=p==="found"?"found_item_id":"item_id",{error:o}=await f.from(a).update({status:"Deleted",admin_feedback:e}).eq(n,b);if(o)throw o;const r=k.find(s=>s.item_id===b);r&&r.user_id&&(await f.from("notifications").insert([{userid:r.user_id,type:"Deleted",message:`Your report was deleted. Reason: ${e}`,is_read:!1,lost_item_id:b}]),le(r,"Deleted",e)),Z.classList.add("hidden"),await W(),await J(),alert("Item marked as deleted.")}catch(a){console.error(a),alert("Failed to delete item")}});async function le(e,a,n){try{const{data:o,error:r}=await f.from("users").select("email, first_name").eq("id",e.user_id).single();if(r||!o||!o.email)return;const s={to_name:o.first_name||"Student",to_email:o.email,complaint_title:`Lost Item: ${e.item_name}`,new_status:a,message:n};await emailjs.send("service_q77wg09","template_sb3k70p",s,"08jWWt0PNjZJ4BcQw"),console.log("Email sent successfully")}catch(o){console.error("Failed to send email:",o)}}function Ie(){const e=document.getElementById("mobileMenuButton"),a=document.getElementById("mobileMenu"),n=document.getElementById("overlay");if(e&&a){const u=e.cloneNode(!0);e.parentNode.replaceChild(u,e),u.addEventListener("click",()=>{a.classList.toggle("-translate-x-full"),n&&n.classList.toggle("hidden")}),n&&n.addEventListener("click",()=>{a.classList.add("-translate-x-full"),n.classList.add("hidden")})}const o=document.getElementById("profileButton"),r=document.getElementById("profileMenu");if(o&&r){const u=o.cloneNode(!0);o.parentNode.replaceChild(u,o),u.addEventListener("click",t=>{t.stopPropagation(),r.classList.contains("hidden")?r.classList.remove("hidden"):r.classList.add("hidden")}),document.addEventListener("click",t=>{!u.contains(t.target)&&!r.contains(t.target)&&r.classList.add("hidden")})}const s=document.getElementById("headerLogoutBtn"),c=document.getElementById("logoutModal");if(s&&c){const u=s.cloneNode(!0);s.parentNode.replaceChild(u,s),u.addEventListener("click",()=>c.classList.remove("hidden"));const t=document.getElementById("cancelLogoutBtn"),l=document.getElementById("confirmLogoutBtn");t&&(t.onclick=()=>c.classList.add("hidden")),l&&(l.onclick=async()=>{await f.auth.signOut(),window.location.href="Login.html"})}}});
