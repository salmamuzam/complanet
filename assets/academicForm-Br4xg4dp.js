import{s as i}from"./darkMode-B-Ivf8oh.js";document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:f}}=await i.auth.getSession();if(!f||!f.user){window.location.href="Login.html";return}const I=document.getElementById("complaintForm");function o(t,e){const n=document.getElementById(t).nextElementSibling;n&&n.classList.contains("error-text")&&(n.textContent=e,n.style.color="var(--color-error, #ff4d4d)")}function l(t){return t.trim()===""?0:t.trim().split(/\s+/).length}function M(t,e,r){const n=document.getElementById(t);let a=n.value.trim();const c=l(a);document.getElementById(e).textContent=`${c} / ${r} words`,c>r&&(n.value=a.split(/\s+/).slice(0,r).join(" "))}const u=document.getElementById("file"),p=document.getElementById("imagePreview");u.addEventListener("change",()=>{p.innerHTML="",u.files&&Array.from(u.files).forEach(t=>{if(t.type.startsWith("image/")){const e=new FileReader;e.onload=r=>{const n=document.createElement("div");n.classList.add("relative","w-24","h-24");const a=document.createElement("img");a.src=r.target.result,a.classList.add("w-full","h-full","object-cover","rounded-lg","border","border-gray-200","shadow-sm");const c=document.createElement("button");c.innerHTML='<i class="fas fa-times"></i>',c.classList.add("absolute","-top-2","-right-2","bg-red-500","text-white","rounded-full","w-6","h-6","flex","items-center","justify-center","text-xs","hover:bg-red-600","shadow-md"),c.onclick=d=>{d.preventDefault(),u.value="",p.innerHTML=""},n.appendChild(a),n.appendChild(c),p.appendChild(n)},e.readAsDataURL(t)}})}),["description","fileDesc","previousAttempt"].forEach(t=>{const e=t==="description"?"descCounter":t==="fileDesc"?"fileCounter":"attemptCounter",r=document.getElementById(t);r&&(r.addEventListener("input",()=>M(t,e,t==="description"?500:100)),r.dispatchEvent(new Event("input")))});let g=f;if(!g||!g.user){window.location.href="Login.html";return}const O=g.user.id;I.addEventListener("submit",async t=>{t.preventDefault(),document.querySelectorAll(".error-text").forEach(s=>s.textContent="");let e=!0;const r=document.getElementById("complaintTitle").value.trim();r||(e=!1,o("complaintTitle","Complaint title is required."));const n=document.getElementById("dateIncident").value,a=new Date(n);(!n||a>=new Date)&&(e=!1,o("dateIncident","Incident date must be before today."));const d=document.getElementById("phone").value.trim();d&&!/^[0-9]{10}$/.test(d)&&(e=!1,o("phone","Phone number must be exactly 10 digits."));const w=document.getElementById("currentLevel").value;w||(e=!1,o("currentLevel","Please select a level."));const b=document.getElementById("semester").value;b||(e=!1,o("semester","Please select a semester."));const y=document.getElementById("description").value.trim();(l(y)>500||!y)&&(e=!1,o("description","Description must be less than 500 words."));const U=document.getElementById("fileDesc").value.trim();l(U)>100&&(e=!1,o("fileDesc","File description must be less than 100 words."));const B=document.getElementById("previousAttempt").value.trim();l(B)>100&&(e=!1,o("previousAttempt","Previous attempts must be less than 100 words."));const D=document.getElementById("desiredOutcome").value.trim();if(l(D)>100&&(e=!1,o("desiredOutcome","Desired outcome must be less than 100 words.")),document.getElementById("declaration").checked||(e=!1,document.getElementById("declaration").nextElementSibling.insertAdjacentHTML("afterend",'<p class="error-text" style="color:red;">You must agree to the declaration.</p>')),!!e)try{const{data:s,error:A}=await i.from("admin").select("id").eq("adminrole","Academic Admin").single();if(A||!s){console.error("Error fetching Academic Admin:",A),alert("System Error: Could not find Academic Admin. Please contact support.");return}const L=s.id,{data:C,error:x}=await i.from("category").select("categoryid").eq("categoryname","Academic").single();if(x||!C){console.error("Error fetching Academic category:",x),alert("System Error: Could not find Academic category. Please contact support.");return}const _=C.categoryid,{data:j,error:P}=await i.from("complaint").insert([{complainantid:O,adminid:L,categoryid:_,submitteddate:new Date().toISOString(),dateofincident:n,complainttitle:r,complaintdescription:y,complaintstatus:"Pending"}]).select().single();if(P){console.error(P);return}const E=j.complaintid,{error:S}=await i.from("academiccomplaint").insert([{complaintid:E,lecturername:document.getElementById("lecturer").value.trim(),batchcode:document.getElementById("batchCode").value.trim(),modulename:document.getElementById("moduleName").value.trim(),currentlevel:w,phone:d,semester:b,specificationofissue:document.getElementById("issueSpec").value.trim(),previousattempts:B,desiredoutcome:D}]);if(S){console.error(S);return}const h=document.getElementById("file"),q=document.getElementById("fileDesc").value.trim();if(h.files.length>0)for(let m=0;m<h.files.length;m++){const v=h.files[m],H=`${Date.now()}_${v.name}`,{data:N,error:F}=await i.storage.from("user-uploads").upload(H,v);if(F){console.error("File upload error:",F),alert("File upload failed. Please try again.");return}const{data:R}=i.storage.from("user-uploads").getPublicUrl(N.path),T=R.publicUrl;console.log("File public URL:",T);const{error:$}=await i.from("complaintattachment").insert([{complaintid:E,fileurl:T,description:q,filename:v.name}]);if($){console.error("Attachment insert error:",$),alert("Failed to save file info. Please try again.");return}}try{await i.from("admin_notifications").insert([{admin_id:L,complaint_id:E,type:"New Complaint",message:`New Academic complaint submitted: "${r}"`,is_read:!1}])}catch(m){console.error("Failed to create admin notification:",m)}I.reset(),alert("Your Academic complaint has been submitted successfully!")}catch(s){console.error(s)}})});
