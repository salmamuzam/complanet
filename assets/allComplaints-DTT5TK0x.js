import{s as g}from"./darkMode-B-Ivf8oh.js";let q=null,S=null,c=[],E=[],H={},y=1;const $=5,M=document.getElementById("complaintsTableBody"),X=document.getElementById("searchInput"),T=document.getElementById("filterStatus"),j=document.getElementById("filterPriority"),B=document.getElementById("filterCategory"),J=document.getElementById("totalComplaintsCount"),ce=document.getElementById("startRange"),me=document.getElementById("endRange"),ue=document.getElementById("totalEntries"),ee=document.getElementById("prevPage"),te=document.getElementById("nextPage"),R=document.getElementById("paginationNumbers"),pe=document.getElementById("complaintRowTemplate");document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:e}}=await g.auth.getSession();if(!e){window.location.href="Login.html";return}ye(),Pe()});async function ye(){const{data:{session:e}}=await g.auth.getSession();if(!e){window.location.href="Login.html";return}const{data:t,error:n}=await g.from("admin").select("id, adminrole, profile_pic").eq("id",e.user.id).single();if(n||!t){alert("Access denied."),window.location.href="Login.html";return}q=t.id,S=t.adminrole;const o=document.getElementById("profileButton");o&&t.profile_pic&&(o.innerHTML=`
            <img src="${t.profile_pic}" alt="Profile" class="h-10 w-10 rounded-full object-cover">
        `),console.log(`Logged in as Admin: ${S} (${q})`),S==="Master Admin"&&B&&B.classList.remove("hidden"),await fe();const r=new URLSearchParams(window.location.search).get("status");r&&T&&(T.value=r);const i=document.getElementById("navDashboard"),a=document.getElementById("navAllComplaints"),d=document.getElementById("navAnalytics"),m=document.getElementById("mobileNavDashboard"),u=document.getElementById("mobileNavAllComplaints"),h=document.getElementById("mobileNavAnalytics");S==="LostAndFound Admin"&&(i&&(i.href="AdminLostFoundDashboard.html"),m&&(m.href="AdminLostFoundDashboard.html"),a&&(a.textContent="Manage Items",a.href="AdminLostFound.html"),u&&(u.textContent="Manage Items",u.href="AdminLostFound.html"),d&&(d.style.display="none"),h&&(h.style.display="none")),ge()}async function ge(){try{M.textContent="";const e=document.createElement("tr"),t=document.createElement("td");t.colSpan=7,t.className="py-6 text-center",t.textContent="Loading complaints...",e.appendChild(t),M.appendChild(e);let n=g.from("complaint").select("*");S!=="Master Admin"&&(n=n.eq("adminid",q)),n=n.neq("complaintstatus","Deleted");const{data:o,error:l}=await n.order("submitteddate",{ascending:!1});if(l)throw l;if(c=o||[],c=c.map(r=>({...r,categoryName:H[r.categoryid]||"Unknown Category"})),c.length>0){const r=[...new Set(c.map(d=>d.complainantid))],{data:i,error:a}=await g.from("users").select("id, first_name, last_name, email").in("id",r);if(!a&&i){const d={};i.forEach(m=>{d[m.id]={name:`${m.first_name} ${m.last_name}`,email:m.email}}),c=c.map(m=>{const u=d[m.complainantid];return{...m,complainantName:u?u.name:"Unknown User",complainantEmail:u?u.email:null}})}}de(),b()}catch(e){console.error("Error loading complaints:",e),M.textContent="";const t=document.createElement("tr"),n=document.createElement("td");n.colSpan=7,n.className="py-6 text-center text-red-500",n.textContent="Error loading complaints. Please try again.",t.appendChild(n),M.appendChild(t)}}async function fe(){try{const{data:e,error:t}=await g.from("category").select("categoryid, categoryname");if(t)throw t;e&&(e.forEach(n=>{H[n.categoryid]=n.categoryname}),console.log("Categories loaded:",H))}catch(e){console.error("Error fetching categories:",e)}}function A(){const e=document.getElementById("complaintsTableBody"),t=document.getElementById("complaintsCardsView");if(e&&(e.textContent=""),t&&(t.textContent=""),E.length===0){if(e){const a=document.createElement("tr"),d=document.createElement("td");d.colSpan=7,d.className="py-8 text-center text-gray-500 dark:text-gray-400",d.innerHTML='<i class="fas fa-inbox text-4xl mb-3 text-gray-300"></i><br>No complaints found.',a.appendChild(d),e.appendChild(a)}t&&(t.innerHTML=`
                <div class="col-span-full py-8 text-center text-gray-500 dark:text-gray-400">
                    <i class="fas fa-inbox text-4xl mb-3 text-gray-300"></i><br>No complaints found.
                </div>
            `);return}const n=(y-1)*$,o=Math.min(n+$,E.length),l=E.slice(n,o);ce.textContent=E.length>0?n+1:0,me.textContent=o,ue.textContent=E.length;const r=document.createDocumentFragment(),i=document.createDocumentFragment();l.forEach(a=>{const d=pe.content.cloneNode(!0);d.querySelector("tr"),d.querySelector(".col-id").textContent=`#${a.complaintid}`,d.querySelector(".col-title").textContent=a.complainttitle||"Untitled";const m=d.querySelector(".col-category"),u=a.categoryName||"General";m.textContent=u;const h=s=>s==="Academic"?"bg-purple-100 text-purple-600 dark:bg-purple-900 dark:text-purple-300":s==="Facility"?"bg-orange-100 text-orange-600 dark:bg-orange-900 dark:text-orange-300":s==="Technical"?"bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-300":s==="Administrative"?"bg-pink-100 text-pink-600 dark:bg-pink-900 dark:text-pink-300":"bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300";m.className=`col-category inline-block px-3 py-1 rounded-full text-xs font-semibold ${h(u)}`;const x=d.querySelector(".col-priority");if(a.priority){const s=f=>f==="High"?"bg-red-100 text-red-600 border border-red-200 dark:bg-red-900/30 dark:text-red-300 dark:border-red-800":f==="Medium"?"bg-yellow-100 text-yellow-600 border border-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-300 dark:border-yellow-800":"bg-blue-100 text-blue-600 border border-blue-200 dark:bg-blue-900/30 dark:text-blue-300 dark:border-blue-800";x.innerHTML=`
                <div class="relative inline-flex items-center justify-center w-28 px-3 py-1.5 rounded text-sm font-medium border ${s(a.priority)}">
                    ${a.priority}
                    <button type="button" class="absolute top-0.5 right-1 inline-flex items-center justify-center text-current hover:opacity-75 focus:outline-none remove-priority-btn" data-id="${a.complaintid}">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
            `,setTimeout(()=>{const f=x.querySelector(".remove-priority-btn");f&&(f.onclick=p=>{p.stopPropagation(),Z(a.complaintid)})},0)}else x.innerHTML=`
                <button class="inline-flex items-center justify-center w-28 px-3 py-1.5 text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 shadow-sm transition-all btn-prioritize" data-id="${a.complaintid}">
                    <i class="fas fa-sort-amount-up mr-1.5"></i> Prioritize
                </button>
            `,setTimeout(()=>{const s=x.querySelector(".btn-prioritize");s&&(s.onclick=f=>{f.stopPropagation(),Q(a.complaintid)})},0);const v=new Date(a.submitteddate).toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"});d.querySelector(".col-date").textContent=v;const z=a.complainantName||"Unknown User";d.querySelector(".complainant-name").textContent=z;const U=d.querySelector(".col-status");U.textContent=a.complaintstatus;const O=s=>s==="Pending"?"bg-red-100 text-red-600 dark:bg-red-900 dark:text-red-300":s==="In-Progress"?"bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300":s==="Resolved"?"bg-green-100 text-green-600 dark:bg-green-900 dark:text-green-300":s==="Deleted"?"bg-gray-200 text-gray-600 dark:bg-gray-700 dark:text-gray-400":"bg-gray-100 text-gray-600";U.className=`col-status py-1 px-3 rounded-full text-xs font-semibold ${O(a.complaintstatus)}`;const V=s=>{const f=s.querySelector(".btn-preview"),p=s.querySelector(".btn-status"),k=s.querySelector(".btn-delete");f&&(f.onclick=()=>window.location.href=`AdminComplaintDetails.html?id=${a.complaintid}`),p&&(p.onclick=()=>Ce(a.complaintid,a.complaintstatus)),k&&(k.onclick=()=>deleteComplaint(a.complaintid))};if(V(d),r.appendChild(d),t){const s=document.getElementById("complaintCardTemplate");if(s){const p=s.content.cloneNode(!0).querySelector("div");p.querySelector(".card-category").textContent=u,p.querySelector(".card-category").className=`card-category px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide ${h(u)}`,p.querySelector(".card-title").textContent=a.complainttitle||"Untitled",p.querySelector(".card-user").textContent=z,p.querySelector(".card-id").textContent=a.complainantid||"N/A",p.querySelector(".card-date").textContent=v;const k=p.querySelector(".card-status");k.textContent=a.complaintstatus,k.className=`card-status px-2 py-0.5 rounded text-[10px] font-bold uppercase ${O(a.complaintstatus)}`;const L=p.querySelector(".card-priority");if(L)if(a.priority){const P=w=>w==="High"?"bg-red-100 text-red-600 border border-red-200 dark:bg-red-900/30 dark:text-red-300 dark:border-red-800":w==="Medium"?"bg-yellow-100 text-yellow-600 border border-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-300 dark:border-yellow-800":"bg-blue-100 text-blue-600 border border-blue-200 dark:bg-blue-900/30 dark:text-blue-300 dark:border-blue-800";L.innerHTML=`
                            <div class="relative inline-flex items-center justify-center w-28 px-3 py-1.5 rounded text-xs font-bold uppercase border ${P(a.priority)}">
                                ${a.priority}
                                <button type="button" class="absolute top-0.5 right-1 inline-flex items-center justify-center text-current hover:opacity-75 focus:outline-none remove-priority-btn-mobile" data-id="${a.complaintid}">
                                    <i class="fas fa-times text-xs"></i>
                                </button>
                            </div>
                        `,setTimeout(()=>{const w=L.querySelector(".remove-priority-btn-mobile");w&&(w.onclick=se=>{se.stopPropagation(),Z(a.complaintid)})},0)}else L.innerHTML=`
                            <button class="inline-flex items-center justify-center w-28 px-3 py-1.5 text-xs font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 shadow-sm transition-all btn-prioritize-mobile" data-id="${a.complaintid}">
                                <i class="fas fa-sort-amount-up mr-1"></i> Prioritize
                            </button>
                        `,setTimeout(()=>{const P=L.querySelector(".btn-prioritize-mobile");P&&(P.onclick=w=>{w.stopPropagation(),Q(a.complaintid)})},0);const W=p.querySelector(".card-desc");W.textContent=a.complaintdescription||"No description provided.",W.title=a.complaintdescription||"",V(p),i.appendChild(p)}}}),e&&e.appendChild(r),t&&t.appendChild(i)}const ne=document.getElementById("statusModal"),oe=document.getElementById("deleteModal"),ae=document.getElementById("modalStatusSelect"),re=document.getElementById("modalStatusReason"),ie=document.getElementById("modalDeleteReason"),be=document.getElementById("confirmStatusBtn"),he=document.getElementById("cancelStatusBtn"),xe=document.getElementById("confirmDeleteBtn"),ve=document.getElementById("cancelDeleteBtn");let C=null;function Ee(e,t){C=e,ae.value=t,re.value="",ne.classList.remove("hidden")}function Y(){ne.classList.add("hidden"),C=null}function we(e){C=e,ie.value="",oe.classList.remove("hidden")}function G(){oe.classList.add("hidden"),C=null}Be();function Be(){he.addEventListener("click",Y),be.addEventListener("click",async()=>{const e=ae.value,t=re.value.trim();if(!t){alert("Please provide a reason for the status change.");return}await ke(C,e,t),Y()}),ve.addEventListener("click",G),xe.addEventListener("click",async()=>{const e=ie.value.trim();if(!e){alert("Please provide a reason for deletion.");return}await Le(C,e),G()})}async function Ce(e,t,n){Ee(e,t)}async function ke(e,t,n){try{const o={complaintstatus:t,admin_feedback:n};t==="Resolved"&&(o.resolveddate=new Date().toISOString(),o.resolvedby=q);const{error:l}=await g.from("complaint").update(o).eq("complaintid",e);if(l)throw l;const r=c.find(i=>i.complaintid===e);if(r&&r.complainantid){const i=`Your complaint "${r.complainttitle||"Complaint"}" status has been updated to ${t}. Reason: ${n}`;await g.from("notifications").insert([{userid:r.complainantid,complaint_id:e,type:t,message:i,is_read:!1}]),await le(r.complainantEmail,r.complainantName,r.complainttitle,t,n)}c=c.map(i=>i.complaintid===e?{...i,...o}:i),b(),alert(`Status updated to ${t} and user notified!`)}catch(o){console.error("Error updating status:",o),alert("Failed to update status.")}}async function le(e,t,n,o,l){if(!e){console.warn("No email found for user. Skipping email notification.");return}const r={to_name:t,to_email:e,complaint_title:n,new_status:o,message:l};try{await emailjs.send("service_q77wg09","template_sb3k70p",r,"08jWWt0PNjZJ4BcQw"),console.log(`Email sent to ${e}`)}catch(i){console.error("EmailJS Error:",i)}}window.deleteComplaint=e=>{we(e)};async function Le(e,t){try{const{error:n}=await g.from("complaint").update({complaintstatus:"Deleted",admin_feedback:t}).eq("complaintid",e);if(n)throw n;const o=c.find(l=>l.complaintid===e);if(o&&o.complainantid){const l=`Your complaint "${o.complainttitle||"Complaint"}" was marked as Deleted. Reason: ${t}`;await g.from("notifications").insert([{userid:o.complainantid,complaint_id:e,type:"Deleted",message:l,is_read:!1}]),await le(o.complainantEmail,o.complainantName,o.complainttitle,"Deleted",t)}c=c.map(l=>l.complaintid===e?{...l,complaintstatus:"Deleted",admin_feedback:t}:l),b(),de(),alert("Complaint deleted and user notified.")}catch(n){console.error("Error deleting complaint:",n),alert("Failed to delete complaint.")}}function b(){const e=X.value.toLowerCase(),t=T.value,n=j.value;E=c.filter(o=>{const l=o.complainttitle&&o.complainttitle.toLowerCase().includes(e)||o.complaintdescription&&o.complaintdescription.toLowerCase().includes(e)||o.complaintid&&o.complaintid.toString().includes(e)||o.complainantName&&o.complainantName.toLowerCase().includes(e),r=t===""||o.complaintstatus===t;let i=!0;n!==""&&(n==="Unprioritized"?i=!o.priority:i=o.priority===n);const a=B?B.value:"",d=a===""||o.categoryName===a,m=document.getElementById("filterDateFrom").value,u=document.getElementById("filterDateTo").value;let h=!0;if(m||u){const x=new Date(o.submitteddate);if(x.setHours(0,0,0,0),m){const v=new Date(m);v.setHours(0,0,0,0),x<v&&(h=!1)}if(u&&h){const v=new Date(u);v.setHours(0,0,0,0),x>v&&(h=!1)}}return l&&r&&i&&d&&h}),y=1,A(),F()}let N=null,I=null;function Q(e){N=e;const t=document.getElementById("priorityModal");t&&(t.classList.remove("hidden"),document.getElementById("modalPrioritySelect").value="High")}function Z(e){I=e;const t=document.getElementById("removePriorityModal");t&&t.classList.remove("hidden")}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("savePriorityBtn"),t=document.getElementById("cancelPriorityBtn"),n=document.getElementById("priorityModal");e&&e.addEventListener("click",async()=>{const i=document.getElementById("modalPrioritySelect").value;N&&i&&(await Se(N,i),n&&n.classList.add("hidden"))}),t&&t.addEventListener("click",()=>{n&&n.classList.add("hidden"),N=null});const o=document.getElementById("confirmRemovePriorityBtn"),l=document.getElementById("cancelRemovePriorityBtn"),r=document.getElementById("removePriorityModal");o&&o.addEventListener("click",async()=>{I&&(await Ie(I),r&&r.classList.add("hidden"),I=null)}),l&&l.addEventListener("click",()=>{r&&r.classList.add("hidden"),I=null})});async function Se(e,t){try{const{error:n}=await g.from("complaint").update({priority:t}).eq("complaintid",e);if(n)throw n;c=c.map(o=>o.complaintid===e?{...o,priority:t}:o),b()}catch(n){console.error("Error updating priority:",n),alert("Failed to update priority.")}}async function Ie(e){try{const{error:t}=await g.from("complaint").update({priority:null}).eq("complaintid",e);if(t)throw t;c=c.map(n=>n.complaintid===e?{...n,priority:null}:n),b()}catch(t){console.error("Error removing priority:",t),alert("Failed to remove priority.")}}function F(){R.textContent="";const e=Math.ceil(E.length/$);if(ee.disabled=y===1,te.disabled=y===e||e===0,window.innerWidth<1280){const n=document.createElement("span");n.className="px-4 py-1 text-sm font-medium text-gray-600 dark:text-gray-300",n.textContent=`Page ${y} of ${e}`,R.appendChild(n);return}if(e<=5+2)for(let n=1;n<=e;n++)D(n);else{D(1),y>3&&K();const n=Math.max(2,y-1),o=Math.min(e-1,y+1);for(let l=n;l<=o;l++)D(l);y<e-2&&K(),D(e)}}function D(e){const t=document.createElement("button");t.textContent=e,t.className=`px-3 py-1 border rounded transition ${y===e?"bg-eco text-white border-eco":"hover:bg-gray-100 dark:hover:bg-gray-700 dark:border-gray-600 dark:text-white"}`,t.addEventListener("click",()=>{y=e,A(),F()}),R.appendChild(t)}function K(){const e=document.createElement("span");e.textContent="...",e.className="px-2 py-1 text-gray-500 dark:text-gray-400",R.appendChild(e)}function Pe(){X.addEventListener("input",b),T.addEventListener("change",b),j&&j.addEventListener("change",b),B&&B.addEventListener("change",b);const e=document.getElementById("filterDateFrom"),t=document.getElementById("filterDateTo");e&&e.addEventListener("change",b),t&&t.addEventListener("change",b),ee.addEventListener("click",()=>{y>1&&(y--,A(),F())}),te.addEventListener("click",()=>{const r=Math.ceil(E.length/$);y<r&&(y++,A(),F())});const n=document.getElementById("headerLogoutBtn");n&&n.addEventListener("click",_);const o=document.getElementById("logoutModal");if(o){const r=document.getElementById("cancelLogoutBtn"),i=document.getElementById("confirmLogoutBtn");r&&r.addEventListener("click",()=>{o.classList.add("hidden")}),i&&i.addEventListener("click",async()=>{const{error:a}=await g.auth.signOut();a&&console.error("Error signing out:",a),window.location.href="Login.html"}),o.addEventListener("click",a=>{a.target===o&&o.classList.add("hidden")})}const l=setInterval(()=>{const r=document.querySelector('#mobileMenu a[href="Login.html"]');if(r)r.addEventListener("click",_),clearInterval(l);else if(document.readyState==="complete"){const i=document.querySelector('#mobileMenu a[href="Login.html"]');i&&i.addEventListener("click",_),clearInterval(l)}},100)}function _(e){e&&e.preventDefault();const t=document.getElementById("logoutModal");t&&t.classList.remove("hidden")}function de(){J&&(J.textContent=c.length)}
