import{s as i}from"./darkMode-B-Ivf8oh.js";const H=5*1024*1024;document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:d}}=await i.auth.getSession();if(!d||!d.user){window.location.href="Login.html";return}const w=document.getElementById("technicalForm"),I=document.getElementById("issueType"),C=document.getElementById("device"),m=document.getElementById("dateIncident"),c=document.getElementById("description"),u=document.getElementById("fileDesc"),f=document.getElementById("previousAttempts"),_=document.getElementById("declaration"),p=document.getElementById("complaintTitle"),B=document.getElementById("descCounter"),D=document.getElementById("fileCounter"),T=document.getElementById("attemptCounter"),b=new Date().toISOString().split("T")[0];m.max=b;function g(n,t,o){n.addEventListener("input",()=>{let e=n.value.trim().split(/\s+/).filter(Boolean);e.length>o&&(n.value=e.slice(0,o).join(" "),e=e.slice(0,o)),t.textContent=`${e.length} / ${o} words`})}const l=document.getElementById("file"),h=document.getElementById("imagePreview");l.addEventListener("change",()=>{h.innerHTML="",l.files&&Array.from(l.files).forEach(n=>{if(n.type.startsWith("image/")){const t=new FileReader;t.onload=o=>{const e=document.createElement("div");e.classList.add("relative","w-24","h-24");const r=document.createElement("img");r.src=o.target.result,r.classList.add("w-full","h-full","object-cover","rounded-lg","border","border-gray-200","shadow-sm");const a=document.createElement("button");a.innerHTML='<i class="fas fa-times"></i>',a.classList.add("absolute","-top-2","-right-2","bg-red-500","text-white","rounded-full","w-6","h-6","flex","items-center","justify-center","text-xs","hover:bg-red-600","shadow-md"),a.onclick=s=>{s.preventDefault(),l.value="",h.innerHTML=""},e.appendChild(r),e.appendChild(a),h.appendChild(e)},t.readAsDataURL(n)}})}),g(c,B,500),g(u,D,100),g(f,T,100),[c,u,f].forEach(n=>{n&&n.dispatchEvent(new Event("input"))});let y=d;if(!y||!y.user){window.location.href="Login.html";return}const q=y.user.id;w.addEventListener("submit",async n=>{n.preventDefault();let t=[];p.value.trim()||t.push("Complaint title is required."),I.value||t.push("Type of Issue is required."),C.value.trim()||t.push("Device / Software Affected is required."),c.value.trim()||t.push("Description of Issue is required."),_.checked||t.push("You must accept the declaration."),m.value>b&&t.push("Date of Issue cannot be in the future.");let e=document.getElementById("file").files[0];if(e&&e.size>H&&t.push("File must be smaller than 5MB."),t.length>0){alert(t.join(`
`));return}try{const{data:r,error:a}=await i.from("admin").select("id").eq("adminrole","Technical Admin").single();if(a||!r){console.error("Error fetching Technical Admin:",a),alert("System Error: Could not find Technical Admin. Please contact support.");return}const s=r.id,{data:L,error:S}=await i.from("category").select("categoryid").eq("categoryname","Technical").single();if(S||!L){console.error("Error fetching Technical category:",S),alert("System Error: Could not find Technical category. Please contact support.");return}const x=L.categoryid,{data:M,error:A}=await i.from("complaint").insert([{complainantid:q,adminid:s,categoryid:x,submitteddate:new Date().toISOString(),dateofincident:m.value,complainttitle:p.value.trim(),complaintdescription:c.value.trim(),complaintstatus:"Pending"}]).select().single();if(A){console.error("Complaint insert failed:",A),alert("Failed to save complaint.");return}const v=M.complaintid,{error:F}=await i.from("technicalcomplaint").insert([{complaintid:v,typeofissue:I.value,deviceaffected:C.value.trim(),previousattempts:f.value.trim()}]);if(F){console.error("Technical insert failed:",F),alert("Failed to save technical complaint.");return}if(e){const E=`${Date.now()}_${e.name}`,{data:$,error:P}=await i.storage.from("user-uploads").upload(E,e);if(P){console.error("File upload error:",P),alert("File upload failed.");return}const{data:j}=i.storage.from("user-uploads").getPublicUrl($.path),U=j.publicUrl;await i.from("complaintattachment").insert([{complaintid:v,fileurl:U,filename:e.name,description:u.value.trim()}])}try{await i.from("admin_notifications").insert([{admin_id:s,complaint_id:v,type:"New Complaint",message:`New Technical complaint submitted: "${p.value}"`,is_read:!1}])}catch(E){console.error("Failed to create admin notification:",E)}w.reset(),B.textContent="0 / 500 words",D.textContent="0 / 100 words",T.textContent="0 / 100 words",alert("Technical complaint submitted successfully!")}catch(r){console.error(r),alert("Something went wrong. Please try again.")}})});
