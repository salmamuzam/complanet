import{s as o}from"./darkMode-B-Ivf8oh.js";document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:p}}=await o.auth.getSession();if(!p||!p.user){window.location.href="Login.html";return}const I=document.getElementById("behaviorForm"),c=document.getElementById("description"),f=document.getElementById("location"),g=document.getElementById("fileDetail"),U=document.getElementById("declaration"),$=document.getElementById("involvedStudents"),b=document.getElementById("misconduct"),y=document.getElementById("previousAttempts"),D=document.getElementById("descCounter"),B=document.getElementById("locationCounter"),S=document.getElementById("fileCounter"),L=document.getElementById("attemptCounter");function M(e){return e.trim().split(/\s+/).filter(Boolean).length}function d(e,n,t){e.addEventListener("input",()=>{let i=M(e.value);i>t&&(e.value=e.value.split(/\s+/).slice(0,t).join(" "),i=t),n.textContent=`${i} / ${t} words`})}const u=document.getElementById("fileUpload"),h=document.getElementById("imagePreview");u.addEventListener("change",()=>{h.innerHTML="",u.files&&Array.from(u.files).forEach((e,n)=>{if(e.type.startsWith("image/")){const t=new FileReader;t.onload=i=>{const r=document.createElement("div");r.classList.add("relative","w-24","h-24");const l=document.createElement("img");l.src=i.target.result,l.classList.add("w-full","h-full","object-cover","rounded-lg","border","border-gray-200","shadow-sm");const a=document.createElement("button");a.innerHTML='<i class="fas fa-times"></i>',a.classList.add("absolute","-top-2","-right-2","bg-red-500","text-white","rounded-full","w-6","h-6","flex","items-center","justify-center","text-xs","hover:bg-red-600","shadow-md"),a.onclick=m=>{m.preventDefault(),u.value="",h.innerHTML=""},r.appendChild(l),r.appendChild(a),h.appendChild(r)},t.readAsDataURL(e)}})}),d(c,D,500),d(f,B,100),d(g,S,100),d(y,L,100),[c,f,g,y].forEach(e=>{e&&e.dispatchEvent(new Event("input"))});let v=p;if(!v||!v.user){window.location.href="Login.html";return}const T=v.user.id;I.addEventListener("submit",async e=>{e.preventDefault();let n=[];const t=document.getElementById("complaintTitle").value.trim();if(t?/^[A-Za-z0-9\s]+$/.test(t)||n.push("Complaint title can only contain letters, numbers, and spaces."):n.push("Complaint title is required."),b.value||n.push("Please select the Nature of Misconduct."),c.value.trim()||n.push("Description is required."),U.checked||n.push("You must declare that the information is accurate."),n.length>0){alert(n.join(`
`));return}try{const{data:i,error:r}=await o.from("admin").select("id").eq("adminrole","Student Disciplinary Admin").single();if(r||!i){console.error("Error fetching Student Disciplinary Admin:",r),alert("System Error: Could not find Student Disciplinary Admin. Please contact support.");return}const l=i.id,{data:a,error:m}=await o.from("category").select("categoryid").eq("categoryname","Student Disciplinary").single();if(m||!a){console.error("Error fetching Student Disciplinary category:",m),alert("System Error: Could not find Student Disciplinary category. Please contact support.");return}const _=a.categoryid,{data:j,error:P}=await o.from("complaint").insert([{complainantid:T,adminid:l,categoryid:_,submitteddate:new Date().toISOString(),dateofincident:new Date().toISOString(),complainttitle:t,complaintdescription:c.value.trim(),complaintstatus:"Pending"}]).select().single();if(P){console.error("Complaint insert error:",P),alert("Failed to submit complaint. Please try again.");return}const E=j.complaintid,{error:A}=await o.from("studentbehaviorcomplaint").insert([{complaintid:E,accusedname:$.value.trim()||null,typeofbehavior:b.value,locationofincident:f.value.trim(),witnessdetail:document.getElementById("witness").value.trim()||null,previousattempts:y.value.trim()||null}]);if(A){console.error("Student behavior insert error:",A),alert("Failed to save student behavior complaint. Please try again.");return}const w=document.getElementById("fileUpload"),q=g.value.trim();if(w.files.length>0)for(let s=0;s<w.files.length;s++){const C=w.files[s],N=`${Date.now()}_${C.name}`,{data:H,error:F}=await o.storage.from("user-uploads").upload(N,C);if(F){console.error("File upload error:",F),alert("File upload failed. Please try again.");return}const{data:O}=o.storage.from("user-uploads").getPublicUrl(H.path),k=O.publicUrl,{error:x}=await o.from("complaintattachment").insert([{complaintid:E,fileurl:k,description:q,filename:C.name}]);if(x){console.error("Attachment insert error:",x),alert("Failed to save file info. Please try again.");return}}try{await o.from("admin_notifications").insert([{admin_id:l,complaint_id:E,type:"New Complaint",message:`New Student Behavior complaint submitted: "${t}"`,is_read:!1}])}catch(s){console.error("Failed to create admin notification:",s)}I.reset(),D.textContent="0 / 500 words",B.textContent="0 / 100 words",S.textContent="0 / 100 words",L.textContent="0 / 100 words",alert("Student behavior complaint submitted successfully!")}catch(i){console.error(i),alert("Something went wrong. Please try again.")}})});
