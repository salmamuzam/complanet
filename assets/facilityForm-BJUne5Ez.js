import{s as r}from"./darkMode-B-Ivf8oh.js";function E(f){return f.trim().split(/\s+/).filter(Boolean).length}const O=5*1024*1024;document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:f}}=await r.auth.getSession();if(!f||!f.user){window.location.href="Login.html";return}const B=f.user.id,g=document.getElementById("facilityComplaintForm"),d=document.getElementById("description"),D=document.getElementById("descCounter"),c=document.getElementById("fileDesc"),C=document.getElementById("fileCounter"),m=document.getElementById("previousAttempt"),F=document.getElementById("prevAttemptCounter"),s=document.getElementById("file"),p=document.getElementById("imagePreview"),A=document.getElementById("declaration"),y=document.getElementById("dateObservation"),T=document.getElementById("complaintTitle"),b=new Date().toISOString().split("T")[0];y&&(y.max=b);function h(i,e,n){!i||!e||i.addEventListener("input",()=>{let a=i.value.trim().split(/\s+/).filter(Boolean);a.length>n&&(i.value=a.slice(0,n).join(" "),a=a.slice(0,n)),e.textContent=`${a.length} / ${n} words`})}h(d,D,500),h(c,C,100),h(m,F,100),[d,c,m].forEach(i=>{i&&i.dispatchEvent(new Event("input"))}),s&&p&&s.addEventListener("change",()=>{p.innerHTML="",s.files&&Array.from(s.files).forEach(i=>{if(i.type.startsWith("image/")){const e=new FileReader;e.onload=n=>{const a=document.createElement("div");a.classList.add("relative","w-24","h-24");const u=document.createElement("img");u.src=n.target.result,u.classList.add("w-full","h-full","object-cover","rounded-lg","border","border-gray-200","shadow-sm");const t=document.createElement("button");t.innerHTML='<i class="fas fa-times"></i>',t.classList.add("absolute","-top-2","-right-2","bg-red-500","text-white","rounded-full","w-6","h-6","flex","items-center","justify-center","text-xs","hover:bg-red-600","shadow-md"),t.onclick=o=>{o.preventDefault(),s.value="",p.innerHTML=""},a.appendChild(u),a.appendChild(t),p.appendChild(a)},e.readAsDataURL(i)}})}),g&&g.addEventListener("submit",async i=>{i.preventDefault();let e=[];const n=T.value.trim();n?/^[A-Za-z0-9\s]+$/.test(n)||e.push("Complaint title can only contain letters, numbers, and spaces."):e.push("Complaint title is required."),document.querySelectorAll(".border-red-500").forEach(t=>{t.classList.remove("border-red-500")}),[{id:"facilityType",label:"Facility Type"},{id:"facilityIssue",label:"Facility Issue"},{id:"floor",label:"Floor"},{id:"dateObservation",label:"Date of Observation"},{id:"description",label:"Description"}].forEach(t=>{const o=document.getElementById(t.id);(!o||!o.value.trim())&&(o&&o.classList.add("border-red-500"),e.push(`${t.label} is required.`))}),y.value>b&&(e.push("Date of observation cannot be in the future."),y.classList.add("border-red-500")),E(d.value)>500&&(e.push("Description cannot exceed 500 words."),d.classList.add("border-red-500")),E(c.value)>100&&(e.push("File description cannot exceed 100 words."),c.classList.add("border-red-500")),E(m.value)>100&&(e.push("Previous attempt cannot exceed 100 words."),m.classList.add("border-red-500"));const u=s.files[0];if(u&&u.size>O&&e.push("Attached file must be less than 5 MB."),A.checked||e.push("You must confirm the declaration."),e.length>0){alert(`Please fix the following issues:

`+e.join(`
`));return}try{const{data:t}=await r.from("admin").select("id").eq("adminrole","Facility Admin").single(),{data:o}=await r.from("category").select("categoryid").eq("categoryname","Facility").single();if(!t||!o){alert("System Error: Could not find Facility Admin or Category.");return}const{data:S,error:w}=await r.from("complaint").insert([{complainantid:B,adminid:t.id,categoryid:o.categoryid,submitteddate:new Date().toISOString(),dateofincident:y.value,complainttitle:n,complaintdescription:d.value.trim(),complaintstatus:"Pending"}]).select().single();if(w)throw w;const v=S.complaintid,{error:I}=await r.from("facilitycomplaint").insert([{complaintid:v,typeoffacility:document.getElementById("facilityType").value,typeoffacilityissue:document.getElementById("facilityIssue").value,facilityfloor:document.getElementById("floor").value,previousattempt:m.value.trim()}]);if(I)throw I;if(s.files.length>0){const l=s.files[0],q=`${Date.now()}_${l.name}`,{data:x,error:L}=await r.storage.from("user-uploads").upload(q,l);if(L)throw L;const{data:M}=r.storage.from("user-uploads").getPublicUrl(x.path);await r.from("complaintattachment").insert([{complaintid:v,fileurl:M.publicUrl,description:c.value.trim(),filename:l.name}])}try{await r.from("admin_notifications").insert([{admin_id:t.id,complaint_id:v,type:"New Complaint",message:`New Facility complaint submitted: "${n}"`,is_read:!1}])}catch(l){console.error("Failed to create admin notification:",l)}g.reset(),[d,c,m].forEach(l=>{l&&l.dispatchEvent(new Event("input"))}),p.innerHTML="",alert("Facility complaint submitted successfully!")}catch(t){console.error(t),alert("Submission failed. Please try again.")}})});
