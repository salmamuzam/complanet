import{s as u}from"./darkMode-B-Ivf8oh.js";async function x(e,a=7,i=10){try{const n=new Date;n.setDate(n.getDate()-a);const r=n.toISOString();let o=[];const t={"Facility Admin":"Facility","Academic Admin":"Academic","Technical Admin":"Technical","Student Disciplinary Admin":"Student Disciplinary","Administrative Admin":"Administrative","General Admin":"Other"},c=e==="Master Admin"?Object.values(t):[t[e]],{data:s,error:d}=await u.from("category").select("categoryid, categoryname").in("categoryname",c);if(d)throw d;for(const l of s){let m=[];switch(l.categoryname){case"Facility":m=await C(l.categoryid,r,i);break;case"Academic":m=await E(l.categoryid,r,i);break;case"Technical":m=await I(l.categoryid,r,i);break;case"Student Disciplinary":m=await A(l.categoryid,r,i);break;case"Administrative":m=await T(l.categoryid,r,i);break}o=o.concat(m)}return o.sort((l,m)=>m.count-l.count),o}catch(n){return console.error("Error fetching trending alerts:",n),[]}}async function C(e,a,i){console.log("üè¢ Fetching facility trends...",{categoryId:e,startDate:a,threshold:i});const{data:n,error:r}=await u.from("complaint").select(`
            complaintid,
            submitteddate,
            facilitycomplaint (
                typeoffacility,
                typeoffacilityissue,
                facilityfloor
            )
        `).eq("categoryid",e).neq("complaintstatus","Deleted");if(console.log("üìä Facility complaints fetched:",n?.length||0,"complaints"),console.log("üîç First complaint sample:",n?.[0]),r)return console.error("Error fetching facility trends:",r),[];const o={};return n.forEach((t,c)=>{if(c<3&&console.log(`Processing complaint ${c}:`,t.facilitycomplaint),t.facilitycomplaint&&typeof t.facilitycomplaint=="object"){const s=t.facilitycomplaint;console.log("Facility complaint data:",s);const d=s.typeoffacilityissue||s.typeOfFacilityIssue,l=s.typeoffacility||s.typeOfFacility,m=s.facilityfloor||s.facilityFloor;if(!l){console.warn("‚ö†Ô∏è No facility type found in:",s);return}const g=l;o[g]||(o[g]={category:"Facility",subcategory:l,count:0,complaintIds:[],issues:new Set,floors:new Set}),o[g].count++,o[g].complaintIds.push(t.complaintid),d&&o[g].issues.add(d),m&&o[g].floors.add(m)}else c<3&&console.warn(`‚ö†Ô∏è Complaint ${t.complaintid} has no facilitycomplaint data`)}),console.log("üìà Grouped facility trends:",Object.values(o).map(t=>({subcategory:t.subcategory,count:t.count}))),console.log("üéØ Filtering with threshold:",i),Object.values(o).filter(t=>t.count>=i).map(t=>{const c=t.issues.size>0?Array.from(t.issues).slice(0,3).join(", "):"Various issues",s=t.floors.size>0?Array.from(t.floors).slice(0,3).join(", "):"";return f({...t,location:t.subcategory,issueTypes:c,floor:s,issues:void 0,floors:void 0})})}async function E(e,a,i){const{data:n,error:r}=await u.from("complaint").select(`
            complaintid,
            submitteddate,
            academiccomplaint (
                specificationofissue,
                modulename,
                currentlevel,
                semester
            )
        `).eq("categoryid",e).neq("complaintstatus","Deleted").gte("submitteddate",a);if(r)return console.error("Error fetching academic trends:",r),[];const o={};return n.forEach(t=>{if(t.academiccomplaint&&typeof t.academiccomplaint=="object"){const c=t.academiccomplaint,s=c.specificationofissue,d=c.currentlevel;if(!s){console.warn("‚ö†Ô∏è No issue type found in academic complaint:",c);return}const l=s;o[l]||(o[l]={category:"Academic",subcategory:s,count:0,complaintIds:[],levels:new Set}),o[l].count++,o[l].complaintIds.push(t.complaintid),d&&o[l].levels.add(d)}}),Object.values(o).filter(t=>t.count>=i).map(t=>{const c=t.levels.size>0?Array.from(t.levels).slice(0,3).join(", "):"";return f({...t,level:c,levels:void 0})})}async function I(e,a,i){const{data:n,error:r}=await u.from("complaint").select(`
            complaintid,
            submitteddate,
            technicalcomplaint (
                typeofissue,
                deviceaffected
            )
        `).eq("categoryid",e).neq("complaintstatus","Deleted").gte("submitteddate",a);if(r)return console.error("Error fetching technical trends:",r),[];const o={};return n.forEach(t=>{if(t.technicalcomplaint&&typeof t.technicalcomplaint=="object"){const c=t.technicalcomplaint,s=c.typeofissue;o[s]||(o[s]={category:"Technical",subcategory:c.typeofissue,count:0,complaintIds:[]}),o[s].count++,o[s].complaintIds.push(t.complaintid)}}),Object.values(o).filter(t=>t.count>=i).map(t=>f(t))}async function A(e,a,i){const{data:n,error:r}=await u.from("complaint").select(`
            complaintid,
            submitteddate,
            studentbehaviorcomplaint (
                typeofbehavior,
                locationofincident
            )
        `).eq("categoryid",e).neq("complaintstatus","Deleted").gte("submitteddate",a);if(r)return console.error("Error fetching behavior trends:",r),[];const o={};return n.forEach(t=>{if(t.studentbehaviorcomplaint&&typeof t.studentbehaviorcomplaint=="object"){const c=t.studentbehaviorcomplaint,s=c.typeofbehavior;o[s]||(o[s]={category:"Student Disciplinary",subcategory:c.typeofbehavior,count:0,complaintIds:[]}),o[s].count++,o[s].complaintIds.push(t.complaintid)}}),Object.values(o).filter(t=>t.count>=i).map(t=>f(t))}async function T(e,a,i){const{data:n,error:r}=await u.from("complaint").select(`
            complaintid,
            submitteddate,
            administrativecomplaint (
                complaintdepartment
            )
        `).eq("categoryid",e).neq("complaintstatus","Deleted").gte("submitteddate",a);if(r)return console.error("Error fetching administrative trends:",r),[];const o={};return n.forEach(t=>{if(t.administrativecomplaint&&typeof t.administrativecomplaint=="object"){const c=t.administrativecomplaint,s=c.complaintdepartment;o[s]||(o[s]={category:"Administrative",subcategory:c.complaintdepartment,count:0,complaintIds:[]}),o[s].count++,o[s].complaintIds.push(t.complaintid)}}),Object.values(o).filter(t=>t.count>=i).map(t=>f(t))}function f(e){const a=S(e.count),i=k(e),n=L(e);return{...e,severity:a.level,severityColor:a.color,severityIcon:a.icon,urgencyMessage:n,actionItems:i,detailedMessage:$(e)}}function S(e){return{level:"warning",color:"yellow",icon:"‚ö†Ô∏è",label:"ATTENTION NEEDED"}}function k(e){const a=[];let i="";switch(e.category){case"Facility":const n=e.location?` in the ${e.location}`:"",r=e.floor?` on ${e.floor}`:"";i=`Please review and address the recurring ${e.subcategory.toLowerCase()} issues${n}${r}. Consider inspecting the area and implementing necessary improvements to prevent future complaints.`;break;case"Technical":i=`Please investigate and resolve the ${e.subcategory.toLowerCase()} affecting users. Consider coordinating with the technical team to implement a permanent solution.`;break;case"Academic":const o=e.level?` for ${e.level} students`:"";i=`Please review the ${e.subcategory.toLowerCase()} concerns${o}. Consider meeting with relevant faculty or staff to address these issues.`;break;case"Student Disciplinary":i=`Please review the reported ${e.subcategory.toLowerCase()} incidents. Consider implementing preventive measures and awareness programs.`;break;case"Administrative":i=`Please review the ${e.subcategory} department concerns. Consider improving service delivery and communication with students.`;break;default:i="Please review and address these recurring complaints to improve the situation."}return a.push({message:i}),a}function L(e,a){const i=e.location?` in ${e.location}`:"",n=e.floor?` (${e.floor})`:"",r=e.level?` for ${e.level} students`:"",o=e.issueTypes?` - Issues include: ${e.issueTypes}`:"";return`‚ö†Ô∏è ATTENTION: ${e.count} complaints about "${e.subcategory}"${i}${n}${r}${o}. Please review and take appropriate action.`}function $(e,a){const i=e.location?` in the ${e.location}`:"",n=e.floor?` on ${e.floor}`:"",r=e.level?` (${e.level} students)`:"";return`The system has detected a significant pattern: <strong>${e.count} complaints</strong> regarding <strong>"${e.subcategory}"</strong>${i}${n}${r} have been submitted recently. This trend indicates a persistent issue that requires your immediate attention and corrective action to improve the situation and prevent future complaints.`}let v=null,y=null,p=[];document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:e}}=await u.auth.getSession();if(!e){window.location.href="Login.html";return}B(),M(),F()});window.navigateToComplaints=function(e){e?window.location.href=`AllComplaints.html?status=${e}`:window.location.href="AllComplaints.html"};async function B(){const{data:{session:e}}=await u.auth.getSession();if(!e){alert("You are not logged in. Redirecting to login page..."),window.location.href="Login.html";return}const{data:a,error:i}=await u.from("admin").select("id, adminfirstname, adminlastname, adminrole, profile_pic").eq("id",e.user.id).single();if(i||!a){alert("Access denied. You are not an admin."),window.location.href="Login.html";return}v=a.id,y=a.adminrole;const n=document.getElementById("welcomeTitle"),r=document.getElementById("welcomeSubtitle");n&&(n.textContent=`Welcome, ${a.adminfirstname} ${a.adminlastname}`),r&&(r.textContent=`${a.adminrole} Dashboard ‚Äî Manage and monitor all ${a.adminrole.toLowerCase()} complaints assigned to you.`);const o=document.getElementById("profileButton");o&&a.profile_pic&&(o.innerHTML=`
            <img src="${a.profile_pic}" alt="Profile" class="h-10 w-10 rounded-full object-cover">
        `);const t=document.getElementById("navDashboard"),c=document.getElementById("navAllComplaints"),s=document.getElementById("navAnalytics"),d=document.getElementById("mobileNavDashboard"),l=document.getElementById("mobileNavAllComplaints"),m=document.getElementById("mobileNavAnalytics");y==="LostAndFound Admin"&&(t&&(t.href="AdminLostFoundDashboard.html"),d&&(d.href="AdminLostFoundDashboard.html"),c&&(c.textContent="Manage Items",c.href="AdminLostFound.html"),l&&(l.textContent="Manage Items",l.href="AdminLostFound.html"),s&&(s.style.display="none"),m&&(m.style.display="none")),D(),P()}async function D(){try{let e=u.from("complaint").select("*");y!=="Master Admin"&&(e=e.eq("adminid",v));const{data:a,error:i}=await e.order("submitteddate",{ascending:!1});if(i){console.error("Error fetching complaints:",i);return}const{data:n}=await u.from("category").select("categoryid, categoryname"),r={};n&&n.forEach(t=>{r[t.categoryid]=t.categoryname}),p=(a||[]).map(t=>({...t,categoryName:r[t.categoryid]||"Uncategorized"})),q(p);const o=p.filter(t=>t.complaintstatus!=="Deleted");N(o.slice(0,5))}catch(e){console.error("Unexpected error loading complaints:",e)}}function q(e){const a=e.length,i=e.filter(t=>t.complaintstatus==="Pending").length,n=e.filter(t=>t.complaintstatus==="In-Progress").length,r=e.filter(t=>t.complaintstatus==="Resolved").length,o=e.filter(t=>t.complaintstatus==="Deleted").length;document.getElementById("totalCount").textContent=a,document.getElementById("pendingCount").textContent=i,document.getElementById("inProgressCount").textContent=n,document.getElementById("resolvedCount").textContent=r,document.getElementById("deletedCount")&&(document.getElementById("deletedCount").textContent=o),document.getElementById("deletedCount")&&(document.getElementById("deletedCount").textContent=o)}function N(e){const a=document.getElementById("recentActivityTable"),i=document.getElementById("recentActivityCards");if(a&&(a.textContent=""),i&&(i.textContent=""),e.length===0){a&&(a.innerHTML='<tr><td colspan="5" class="py-6 text-center text-gray-500">No recent activity found.</td></tr>'),i&&(i.innerHTML='<p class="text-center text-gray-500 py-4">No recent activity found.</p>');return}e.forEach(n=>{const r=new Date(n.submitteddate).toLocaleDateString();let o="bg-gray-200 text-gray-700";if(n.complaintstatus==="Pending"?o="bg-yellow-100 text-yellow-700":n.complaintstatus==="In-Progress"?o="bg-purple-100 text-purple-700":n.complaintstatus==="Resolved"?o="bg-green-100 text-green-700":n.complaintstatus==="Deleted"&&(o="bg-gray-200 text-gray-600"),a){const t=document.getElementById("recentActivityRowTemplate");if(t){const c=t.content.cloneNode(!0);c.querySelector("tr"),c.querySelector(".col-title").textContent=n.complainttitle||"Untitled",c.querySelector(".col-category").textContent=n.categoryName,c.querySelector(".col-date").textContent=r;const s=c.querySelector(".col-status");s.textContent=n.complaintstatus,s.className=`col-status py-1 px-3 rounded-full text-xs font-semibold ${o}`;const d=c.querySelector(".col-link");d.href=`AdminComplaintDetails.html?id=${n.complaintid}`,a.appendChild(c)}}if(i){const t=document.getElementById("activityCardTemplate");if(t){const s=t.content.cloneNode(!0).querySelector("div");s.querySelector(".card-title").textContent=n.complainttitle||"Untitled";const d=s.querySelector(".card-status");d.textContent=n.complaintstatus,d.className=`card-status py-1 px-2 rounded text-[10px] font-bold uppercase tracking-wide whitespace-nowrap ml-2 ${o}`,s.querySelector(".card-category").textContent=n.categoryName,s.querySelector(".card-date").textContent=r;const l=s.querySelector(".card-link");l.href=`AdminComplaintDetails.html?id=${n.complaintid}`,i.appendChild(s)}}})}function M(){const e=document.getElementById("headerLogoutBtn");e&&e.addEventListener("click",h);const a=document.getElementById("logoutModal");if(a){const n=document.getElementById("cancelLogoutBtn"),r=document.getElementById("confirmLogoutBtn");n&&n.addEventListener("click",()=>{a.classList.add("hidden")}),r&&r.addEventListener("click",async()=>{const{error:o}=await u.auth.signOut();o&&console.error("Error signing out:",o),window.location.href="Login.html"}),a.addEventListener("click",o=>{o.target===a&&a.classList.add("hidden")})}const i=setInterval(()=>{const n=document.querySelector('#mobileMenu a[href="Login.html"]');if(n)n.addEventListener("click",h),clearInterval(i);else if(document.readyState==="complete"){const r=document.querySelector('#mobileMenu a[href="Login.html"]');r&&r.addEventListener("click",h),clearInterval(i)}},100)}function h(e){e&&e.preventDefault();const a=document.getElementById("logoutModal");a&&a.classList.remove("hidden")}function F(){const e=document.getElementById("adminNotepad"),a=document.getElementById("saveStatus");if(!e)return;const i=localStorage.getItem("admin_scratchpad_notes");i&&(e.value=i);let n;e.addEventListener("input",()=>{a.textContent="Saving...",clearTimeout(n),n=setTimeout(()=>{localStorage.setItem("admin_scratchpad_notes",e.value),a.textContent="Auto-saved",a.classList.add("text-green-600","dark:text-green-400"),setTimeout(()=>{a.classList.remove("text-green-600","dark:text-green-400")},1e3)},500)})}async function P(){if(!y){console.log("Admin role not yet loaded, skipping trend alerts");return}if(y==="General Admin"){const n=document.getElementById("trendAlertsSection");n&&(n.style.display="none");return}const e=document.getElementById("trendAlertsContainer");if(!e)return;e.innerHTML=`
        <div class="text-center py-8">
            <i class="fas fa-spinner fa-spin text-3xl text-gray-400 mb-3"></i>
            <p class="text-gray-500 dark:text-gray-400">Analyzing complaint patterns...</p>
        </div>
    `;const a=36500,i=10;console.log(`üîç Loading trend alerts for ${y}, last ${a} days, threshold: ${i}`);try{const n=await x(y,a,i);if(console.log(`‚úÖ Got ${n.length} alerts:`,n),n.length===0){const r=document.getElementById("noAlertsTemplate");if(r){e.innerHTML="";const o=r.content.cloneNode(!0);e.appendChild(o)}}else e.innerHTML="",n.forEach(r=>{O(r,e)})}catch(n){console.error("Error loading trend alerts:",n),e.innerHTML=`
            <div class="text-center py-8 bg-red-50 dark:bg-red-900/20 rounded-xl">
                <i class="fas fa-exclamation-triangle text-3xl text-red-500 mb-3"></i>
                <p class="text-red-600 dark:text-red-400">Error loading trend alerts. Please try again later.</p>
            </div>
        `}}function O(e,a){const i=document.getElementById("alertCardTemplate");if(!i)return;const n=i.content.cloneNode(!0),r=n.querySelector(".alert-card"),o={critical:"border-red-500",high:"border-orange-500",warning:"border-yellow-500"};r.classList.add(o[e.severity]||"border-yellow-500"),n.querySelector(".alert-icon").textContent=e.severityIcon;const t=n.querySelector(".alert-severity-label"),c={critical:"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200",high:"bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200",warning:"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200"};t.textContent=e.severityIcon+" "+(e.severity==="critical"?"CRITICAL":e.severity==="high"?"HIGH PRIORITY":"ATTENTION NEEDED"),t.className=`alert-severity-label text-xs font-bold uppercase tracking-wider px-2 py-1 rounded ${c[e.severity]}`;const s=e.location?`${e.subcategory} - ${e.location}${e.floor?" ("+e.floor+")":""}`:e.subcategory;n.querySelector(".alert-title").textContent=s;const d=n.querySelector(".alert-count-badge div:first-child"),l={critical:"text-red-600 dark:text-red-400",high:"text-orange-600 dark:text-orange-400",warning:"text-yellow-600 dark:text-yellow-400"};d.textContent=e.count,d.className=`text-3xl font-bold ${l[e.severity]}`;const m=n.querySelector(".alert-urgency-message"),g={critical:"bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800",high:"bg-orange-50 dark:bg-orange-900/30 border border-orange-200 dark:border-orange-800",warning:"bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-800"};m.innerHTML=e.urgencyMessage,m.className=`alert-urgency-message p-4 rounded-lg mb-4 ${g[e.severity]} text-gray-800 dark:text-gray-200 font-medium text-sm`,n.querySelector(".alert-detailed-message").innerHTML=e.detailedMessage;const b=n.querySelector(".alert-action-items");e.actionItems.forEach(w=>{j(w,b)}),a.appendChild(n)}function j(e,a){const i=document.createElement("div");i.className="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border-l-4 border-blue-500";const n=document.createElement("p");n.className="text-sm text-gray-700 dark:text-gray-300 leading-relaxed",n.innerHTML=`<i class="fas fa-info-circle text-blue-500 mr-2"></i>${e.message}`,i.appendChild(n),a.appendChild(i)}
