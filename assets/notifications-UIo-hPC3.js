import{s as m}from"./darkMode-B-Ivf8oh.js";let p=null;const b=document.getElementById("notificationBtn"),g=document.getElementById("notificationBadge");document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:e}}=await m.auth.getSession();if(!e){window.location.href="Login.html";return}_();const i=document.getElementById("fullNotificationList");i&&T(i)});async function _(){const{data:{user:e}}=await m.auth.getUser();e&&(p=e,b&&b.addEventListener("click",i=>{i.stopPropagation(),window.location.href="Notifications.html"}),await L())}async function L(){try{const{data:e,error:i}=await m.from("notifications").select("*").eq("userid",p.id).order("created_at",{ascending:!1}).limit(20);if(i){console.warn("Notifications table issue:",i);return}E(e)}catch(e){console.error("Error fetching notifications:",e)}}function E(e){if(!e||e.length===0){g&&g.classList.add("hidden");return}const i=e.filter(t=>!t.is_read).length;i>0&&g?(g.textContent=i>9?"9+":i,g.classList.remove("hidden")):g&&g.classList.add("hidden")}async function T(e){if(!p){const{data:{user:o}}=await m.auth.getUser();o&&(p=o)}if(!p)return;const i=document.getElementById("markAllReadPageBtn");i&&(i.onclick=async()=>{await m.from("notifications").update({is_read:!0}).eq("userid",p.id),C(e),L()});const t=document.getElementById("mobileMenuButton"),a=document.getElementById("mobileMenu");if(t&&a){const o=t.cloneNode(!0);t.parentNode.replaceChild(o,t),o.addEventListener("click",n=>{n.stopPropagation(),a.classList.toggle("-translate-x-full")}),document.addEventListener("click",n=>{!a.contains(n.target)&&!o.contains(n.target)&&a.classList.add("-translate-x-full")})}C(e)}async function C(e){e.innerHTML="";const i=document.getElementById("notificationsLoadingTemplate");i?e.appendChild(i.content.cloneNode(!0)):e.textContent="Loading notifications...";const{data:t,error:a}=await m.from("notifications").select("*").eq("userid",p.id).order("created_at",{ascending:!1});if(a||!t){e.innerHTML="";const o=document.getElementById("notificationsErrorTemplate");o?e.appendChild(o.content.cloneNode(!0)):e.textContent="Failed to load notifications.";return}if(t.length===0){e.innerHTML="";const o=document.getElementById("notificationsEmptyTemplate");o?e.appendChild(o.content.cloneNode(!0)):e.textContent="You have no notifications.";return}e.innerHTML="",t.forEach(o=>{const n=v(o);e.appendChild(n)})}function v(e){const i=document.getElementById("notificationItemTemplate");if(!i)return null;const t=i.content.cloneNode(!0),a=t.querySelector(".notification-card"),o=e.type==="Resolved"||e.type==="resolved",n=`timeline-${e.id}`,r=e.is_read?["bg-white","dark:bg-gray-800","opacity-90"]:["bg-[var(--color-eco-light)]","dark:bg-[var(--color-green-dark)]"];a.classList.add(...r);const s=t.querySelector(".notification-icon");let l="fa-info-circle text-[var(--color-blue-btn)]";o&&(l="fa-check-circle text-resolved"),(e.type==="Deleted"||e.type==="deleted")&&(l="fa-trash-alt text-pending"),s.className=`notification-icon fas ${l}`,t.querySelector(".notification-message").textContent=e.message,t.querySelector(".notification-date").textContent=new Date(e.created_at).toLocaleString();const c=t.querySelector(".notification-chevron"),u=t.querySelector(".notification-timeline");if(["in-progress","resolved","pending","deleted","lost","claim","found","lostitemupdate","itemdeleted"].includes(e.type.toLowerCase())){c.classList.remove("hidden"),u.id=n;const d=e.lost_item_id?"lost_item":"complaint",f=e.lost_item_id||e.complaint_id;c.onclick=w=>{w.stopPropagation(),B(f,d,u,c,e.created_at)}}return a.onclick=async d=>{d.target.closest("button")||d.target.closest(`#${n}`)||e.is_read||(await m.from("notifications").update({is_read:!0}).eq("id",e.id),a.classList.remove("bg-[var(--color-eco-light)]","dark:bg-[var(--color-green-dark)]"),a.classList.add("bg-white","dark:bg-gray-800","opacity-90"),L())},a}async function B(e,i,t,a,o){if(t.classList.contains("hidden")){if(t.classList.remove("hidden"),a.classList.add("rotate-180"),!t.dataset.loaded){t.innerHTML="";const r=document.getElementById("timelineLoadingTemplate");r?t.appendChild(r.content.cloneNode(!0)):t.textContent="Loading history...";try{let s=null,l="";if(i==="lost_item"){l="lost_item_id";const{data:d,error:f}=await m.from("lost_and_found").select("reported_date, item_name").eq("item_id",e).single();if(f)throw f;s={type:"Lost",created_at:d.reported_date,message:`Item "${d.item_name||"Reported Item"}" was reported.`}}else{l="complaint_id";const{data:d,error:f}=await m.from("complaint").select("submitteddate, complainttitle").eq("complaintid",e).single();if(f)throw f;s={type:"Pending",created_at:d.submitteddate,message:`Complaint "${d.complainttitle||"Submitted"}" was received.`}}const{data:c,error:u}=await m.from("notifications").select("*").eq(l,e).lte("created_at",o).order("created_at",{ascending:!0});if(u)throw u;const y=c.filter(d=>d.type!==s.type),h=[s,...y];S(t,h),t.dataset.loaded="true"}catch(s){console.error("Timeline error:",s),t.innerHTML="";const l=document.getElementById("timelineErrorTemplate");l?t.appendChild(l.content.cloneNode(!0)):t.textContent="Failed to load history."}}}else t.classList.add("hidden"),a.classList.remove("rotate-180")}function S(e,i){if(e.innerHTML="",!i||i.length===0){e.textContent="No history found.";return}const t=document.createElement("div");t.className="space-y-4";const a=document.getElementById("timelineItemTemplate");i.forEach(o=>{let n="bg-gray-400",r=o.type||"Update";const s=(o.type||"").toLowerCase();s==="pending"?(n="bg-red-500",r="Complaint Submitted"):s==="in-progress"?(n="bg-yellow-500",r="In Progress"):s==="resolved"?(n="bg-green-500",r="Resolved"):s==="lost"?(n="bg-orange-500",r="Item Reported (Lost)"):s==="claim"?(n="bg-blue-500",r="Potential Match Found"):s==="found"?(n="bg-green-500",r="Item Returned / Found"):s==="deleted"||s==="itemdeleted"?(n="bg-gray-500",r="Deleted"):s==="lostitemupdate"&&(n="bg-blue-400",r="Status Update");let l=o.message||"";if(l.includes("Reason:")&&(l=l.split("Reason:")[1].trim()),a){const c=a.content.cloneNode(!0),u=c.querySelector(".timeline-dot");u.className=`timeline-dot w-3 h-3 rounded-full mt-1.5 border-2 border-white dark:border-gray-800 ${n}`;const y=new Date(o.created_at).toLocaleDateString(),h=new Date(o.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});c.querySelector(".timeline-date").textContent=`${y} â€¢ ${h}`,c.querySelector(".timeline-title").textContent=r,c.querySelector(".timeline-message").textContent=l,t.appendChild(c)}}),e.appendChild(t)}
