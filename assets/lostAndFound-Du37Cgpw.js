import{s as o}from"./darkMode-B-Ivf8oh.js";document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:m}}=await o.auth.getSession();if(!m||!m.user){window.location.href="Login.html";return}const _=document.getElementById("lostItemForm"),f=m.user.id,i=document.getElementById("itemImage"),c=document.getElementById("imagePreview");i.addEventListener("change",()=>{c.innerHTML="",i.files&&Array.from(i.files).forEach(l=>{if(l.type.startsWith("image/")){const r=new FileReader;r.onload=s=>{const e=document.createElement("div");e.classList.add("relative","w-24","h-24");const a=document.createElement("img");a.src=s.target.result,a.classList.add("w-full","h-full","object-cover","rounded-lg","border","border-gray-200","shadow-sm");const t=document.createElement("button");t.innerHTML='<i class="fas fa-times"></i>',t.classList.add("absolute","-top-2","-right-2","bg-red-500","text-white","rounded-full","w-6","h-6","flex","items-center","justify-center","text-xs","hover:bg-red-600","shadow-md"),t.onclick=u=>{u.preventDefault(),i.value="",c.innerHTML=""},e.appendChild(a),e.appendChild(t),c.appendChild(e)},r.readAsDataURL(l)}})}),_.addEventListener("submit",async l=>{l.preventDefault();const r=document.getElementById("itemName").value.trim(),s=document.getElementById("itemType").value,e=document.getElementById("brand").value.trim(),a=document.getElementById("model").value.trim(),t=document.getElementById("primaryColor").value.trim(),u=document.getElementById("secondaryColor").value.trim(),v=document.getElementById("serialNumber").value.trim(),b=document.getElementById("locationLost").value.trim(),p=document.getElementById("dateLost").value,w=document.getElementById("timeLost").value,L=document.getElementById("distinguishingFeatures").value.trim(),B=document.getElementById("description").value.trim(),d=document.getElementById("itemImage");if(!r||!s||!p){alert("Please fill in all required fields.");return}if(d.files.length>0){const n=d.files[0];if(!["image/jpeg","image/png","image/jpg","image/gif"].includes(n.type)){alert("Invalid file attachment. Please upload an image.");return}}try{const{data:n,error:g}=await o.from("admin").select("id").eq("adminrole","LostAndFound Admin").single();if(g||!n){console.error("Error fetching Lost & Found admin:",g),alert("Unable to assign admin. Please contact support.");return}const D=n.id,{data:C,error:y}=await o.from("lost_and_found").insert([{user_id:f,admin_id:D,item_name:r,item_type:s,brand:e||null,model:a||null,primary_color:t||null,secondary_color:u||null,serial_number:v||null,location_lost:b,date_lost:p,time_lost:w||null,distinguishing_features:L||null,description:B||null,status:"Lost"}]).select().single();if(y){console.error("Error submitting report:",y),alert("Failed to submit report. Please try again.");return}const F=C.item_id;if(d.files.length>0){const h=d.files[0],x=h.name.split(".").pop(),P=`lost_${f}_${Date.now()}.${x}`,{data:T,error:E}=await o.storage.from("lost_found_images").upload(P,h);if(E)console.error("Image upload failed:",E),alert("Report submitted, but image upload failed.");else{const{data:A}=o.storage.from("lost_found_images").getPublicUrl(T.path),U=A.publicUrl,{error:I}=await o.from("lost_found_attachments").insert([{lost_item_id:F,file_url:U,file_type:"image",uploaded_at:new Date().toISOString()}]);I&&console.error("Error saving attachment link:",I)}}alert("Lost item reported successfully!"),window.location.href="Mycomplaint.html?tab=lostfound"}catch(n){console.error("Unexpected error:",n),alert("An unexpected error occurred.")}})});
