import{s as r}from"./darkMode-B-Ivf8oh.js";const N=document.getElementById("complaintTitle"),h=document.getElementById("statusBadge"),_=document.getElementById("complaintId"),S=document.getElementById("submittedDate"),P=document.getElementById("complaintDescription"),q=document.getElementById("categoryDetailsCard"),F=document.getElementById("categoryName"),L=document.getElementById("categoryFields"),T=document.getElementById("category-field-template"),g=document.getElementById("attachmentsContainer"),U=document.getElementById("attachment-item-template"),p=document.getElementById("avatarInitials"),y=document.getElementById("avatarImage"),w=document.getElementById("complainantName"),B=document.getElementById("complainantRole"),v=document.getElementById("complainantId"),A=document.getElementById("complainantEmail"),D=document.getElementById("complainantDept"),k=document.getElementById("feedbackContainer"),E=document.getElementById("adminInitials"),b=document.getElementById("adminProfileImage"),M=document.getElementById("adminName");let C=null;document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:n}}=await r.auth.getSession();if(!n){window.location.href="Login.html";return}if(C=new URLSearchParams(window.location.search).get("id"),!C){alert("No complaint ID provided."),window.location.href="AllComplaints.html";return}$()});async function $(){const{data:{session:n}}=await r.auth.getSession();if(!n){window.location.href="Login.html";return}const{data:e,error:t}=await r.from("admin").select("id, adminrole, profile_pic").eq("id",n.user.id).single();if(t||!e){alert("Access denied."),window.location.href="Login.html";return}const i=document.getElementById("profileButton");i&&e.profile_pic&&(i.innerHTML=`
            <img src="${e.profile_pic}" alt="Profile" class="h-10 w-10 rounded-full object-cover">
        `);const o=e.adminrole,a=document.getElementById("navDashboard"),s=document.getElementById("navAllComplaints"),c=document.getElementById("navAnalytics"),d=document.getElementById("mobileNavDashboard"),l=document.getElementById("mobileNavAllComplaints"),u=document.getElementById("mobileNavAnalytics");o==="LostAndFound Admin"&&(a&&(a.href="AdminLostFoundDashboard.html"),d&&(d.href="AdminLostFoundDashboard.html"),s&&(s.textContent="Manage Items",s.href="AdminLostFound.html"),l&&(l.textContent="Manage Items",l.href="AdminLostFound.html"),c&&(c.style.display="none"),u&&(u.style.display="none")),O(C)}async function O(n){try{console.log("Loading details for complaint:",n);const{data:e,error:t}=await r.from("complaint").select("*").eq("complaintid",n).single();if(t||!e){console.error("Error fetching complaint:",t),alert("Complaint not found.");return}const{data:i}=await r.from("category").select("categoryname").eq("categoryid",e.categoryid).single(),o=i?i.categoryname:"Unknown";console.log("Category:",o);let a=null;if(e.complainantid){const{data:m,error:f}=await r.from("users").select("*").eq("id",e.complainantid).single();!f&&m?a=m:console.warn("Could not fetch user info:",f)}const{data:s,error:c}=await r.from("complaintattachment").select("*").eq("complaintid",n);c&&console.warn("Error fetching attachments:",c);let d=null,l="";if(o==="Technical"?l="technicalcomplaint":o==="Student Disciplinary"?l="studentbehaviorcomplaint":o==="Facility"?l="facilitycomplaint":o==="Administrative"?l="administrativecomplaint":o==="Academic"?l="academiccomplaint":o==="Other"&&(l="othercomplaint"),l){const{data:m,error:f}=await r.from(l).select("*").eq("complaintid",n).single();f?console.warn(`Error fetching ${l}:`,f):d=m}let u="Unassigned",x=null;if(e.adminid){const{data:m}=await r.from("admin").select("adminfirstname, adminlastname, profile_pic").eq("id",e.adminid).single();m&&(u=`${m.adminfirstname} ${m.adminlastname}`,x=m)}j(e,o,a,u,x),W(o,d),H(s),J(e)}catch(e){console.error("Unexpected error:",e),alert("An error occurred while loading details.")}}function j(n,e,t,i,o){N.textContent=n.complainttitle||"Untitled",_.textContent=`#${n.complaintid}`;const a=new Date(n.submitteddate);if(S.textContent=isNaN(a)?"N/A":a.toLocaleString(),h.textContent=n.complaintstatus,h.className=`px-3 py-1 rounded-full text-xs font-bold border inline-block ${Q(n.complaintstatus)}`,h.classList.remove("hidden"),P.textContent=n.complaintdescription||"No description provided.",t)if(w.textContent=`${t.first_name||""} ${t.last_name||""}`,B.textContent=t.role||"Student",v.textContent=t.id||"N/A",v.title=t.id||"",A.textContent=t.email||"N/A",D.textContent=t.department||"N/A",t.profile_image_url)y.src=t.profile_image_url,y.classList.remove("hidden"),p.classList.add("hidden");else{const c=t.first_name?t.first_name[0]:"",d=t.last_name?t.last_name[0]:"";p.innerText=(c+d).toUpperCase()||"U",y.classList.add("hidden"),p.classList.remove("hidden")}else w.textContent="Unknown User",B.textContent="N/A",v.textContent="N/A",A.textContent="N/A",D.textContent="N/A",p.innerText="U",y.classList.add("hidden"),p.classList.remove("hidden");if(M.textContent=i,o&&o.profile_pic)b.src=o.profile_pic,b.classList.remove("hidden"),E.classList.add("hidden");else{const c=i!=="Unassigned"?i.split(" ").map(d=>d[0]).join(""):"U";E.textContent=c,b.classList.add("hidden"),E.classList.remove("hidden")}const s=document.getElementById("deleteComplaintBtn");s&&(n.complaintstatus==="Deleted"?s.classList.add("hidden"):(s.classList.remove("hidden"),s.onclick=()=>R(n)))}async function R(n){const e=prompt("Enter a reason for deleting this complaint:");if(e)try{const{error:t}=await r.from("complaint").update({complaintstatus:"Deleted",admin_feedback:e||"Deleted by Admin"}).eq("complaintid",n.complaintid);if(t)throw t;const i=`Your complaint "${n.complainttitle}" was marked as Deleted. Reason: ${e}`;if(await r.from("notifications").insert([{userid:n.complainantid,complaint_id:n.complaintid,type:"Deleted",message:i,is_read:!1}]),n.complainantEmail){const o={to_name:n.complainantName||"Student",to_email:n.complainantEmail,complaint_title:n.complainttitle,new_status:"Deleted",message:i};emailjs.send("service_q77wg09","template_sb3k70p",o,"08jWWt0PNjZJ4BcQw").then(()=>console.log("Email sent")).catch(a=>console.error("Email failed",a))}alert("Complaint deleted successfully."),window.location.href="AllComplaints.html"}catch(t){console.error("Error deleting complaint:",t),alert("Failed to delete complaint.")}}function W(n,e){if(!e)return;q.classList.remove("hidden"),F.textContent=n,L.textContent="";const t=(i,o)=>{const a=T.content.cloneNode(!0),s=a.querySelector(".field-label"),c=a.querySelector(".field-value");s.textContent=i,c.textContent=o||"N/A",o||c.classList.add("italic","text-gray-400"),L.appendChild(a)};n==="Technical"?(t("Type of Issue",e.typeofissue),t("Device Affected",e.deviceaffected),t("Previous Attempts",e.previousattempts)):n==="Student Disciplinary"?(t("Accused Name",e.accusedname),t("Type of Behavior",e.typeofbehavior),t("Location",e.locationofincident),t("Witness Details",e.witnessdetail),t("Previous Attempts",e.previousattempts)):n==="Facility"?(t("Facility Type",e.typeoffacility),t("Issue",e.typeoffacilityissue),t("Floor",e.facilityfloor),t("Previous Attempt",e.previousattempt)):n==="Administrative"?(t("Department",e.complaintdepartment),t("Staff Involved",e.staffinvolved),t("Desired Outcome",e.desiredoutcome),t("Previous Attempts",e.previousattempts)):n==="Academic"?(t("Lecturer Name",e.lecturername),t("Module Name",e.modulename),t("Batch Code",e.batchcode),t("Level",e.currentlevel),t("Semester",e.semester),t("Issue",e.specificationofissue),t("Phone",e.phone),t("Desired Outcome",e.desiredoutcome),t("Previous Attempts",e.previousattempts)):n==="Other"&&(t("Suggested Category",e.suggestedcategory),t("Desired Outcome",e.desiredoutcome),t("Previous Attempts",e.previousattempts))}function H(n){if(!n||n.length===0){g.textContent="";const e=document.createElement("p");e.className="text-gray-500 text-sm italic",e.textContent="No attachments found.",g.appendChild(e);return}g.textContent="",n.forEach(e=>{const t=U.content.cloneNode(!0),i=t.querySelector(".attachment-link"),o=t.querySelector(".attachment-filename"),a=t.querySelector(".attachment-desc");i.href=e.fileurl,o.textContent=e.filename,a.textContent=e.description||"Attachment",g.appendChild(t)})}function J(n){k.textContent="";const e=document.createElement("p");n.admin_feedback?(e.className="text-gray-700 dark:text-gray-300 whitespace-pre-wrap",e.textContent=n.admin_feedback):(e.className="text-gray-500 text-sm italic",e.textContent="No feedback provided yet."),k.appendChild(e)}function Q(n){switch(n){case"Pending":return"bg-yellow-100 text-yellow-800 border-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-300 dark:border-yellow-800";case"In-Progress":return"bg-blue-100 text-blue-800 border-blue-200 dark:bg-blue-900/30 dark:text-blue-300 dark:border-blue-800";case"Resolved":return"bg-green-100 text-green-800 border-green-200 dark:bg-green-900/30 dark:text-green-300 dark:border-green-800";case"Deleted":return"bg-red-100 text-red-800 border-red-200 dark:bg-red-900/30 dark:text-red-300 dark:border-red-800";default:return"bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300"}}function Y(){const n=document.getElementById("headerLogoutBtn");n&&n.addEventListener("click",I);const e=document.getElementById("logoutModal");if(e){const i=document.getElementById("cancelLogoutBtn"),o=document.getElementById("confirmLogoutBtn");i&&i.addEventListener("click",()=>{e.classList.add("hidden")}),o&&o.addEventListener("click",async()=>{const{error:a}=await r.auth.signOut();a&&console.error("Error signing out:",a),window.location.href="Login.html"}),e.addEventListener("click",a=>{a.target===e&&e.classList.add("hidden")})}const t=setInterval(()=>{const i=document.querySelector('#mobileMenu a[href="Login.html"]');if(i)i.addEventListener("click",I),clearInterval(t);else if(document.readyState==="complete"){const o=document.querySelector('#mobileMenu a[href="Login.html"]');o&&o.addEventListener("click",I),clearInterval(t)}},100)}function I(n){n&&n.preventDefault();const e=document.getElementById("logoutModal");e&&e.classList.remove("hidden")}Y();
