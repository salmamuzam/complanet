import{s as a}from"./darkMode-B-Ivf8oh.js";document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:p}}=await a.auth.getSession();if(!p){window.location.href="Login.html";return}const{data:h,error:_}=await a.from("admin").select("id, adminrole, profile_pic").eq("id",p.user.id).single();if(_||!h){window.location.href="Login.html";return}const I=document.getElementById("profileButton");I&&h.profile_pic&&(I.innerHTML=`
            <img src="${h.profile_pic}" alt="Profile" class="h-10 w-10 rounded-full object-cover pointer-events-none">
        `),document.getElementById("uploadFoundItemForm");const y=document.getElementById("foundItemImage"),c=document.getElementById("imagePreview"),b=document.getElementById("previewImg"),B=document.getElementById("uploadPlaceholder"),m=document.getElementById("confirmUploadFoundBtn");M();const L=new Date().toLocaleDateString("en-CA");document.getElementById("foundDateFound").setAttribute("max",L),y.addEventListener("change",e=>{const o=e.target.files[0];if(o){const i=new FileReader;i.onload=u=>{b.src=u.target.result,c.classList.remove("hidden"),B.classList.add("hidden");let t=c.querySelector(".delete-preview-btn");t||(t=document.createElement("button"),t.innerHTML='<i class="fas fa-times"></i>',t.classList.add("delete-preview-btn","absolute","-top-2","-right-2","bg-red-500","text-white","rounded-full","w-6","h-6","flex","items-center","justify-center","text-xs","hover:bg-red-600","shadow-md","z-10"),t.onclick=d=>{d.preventDefault(),y.value="",c.classList.add("hidden"),B.classList.remove("hidden")},c.classList.add("relative"),c.appendChild(t))},i.readAsDataURL(o)}else c.classList.add("hidden"),B.classList.remove("hidden")}),m.addEventListener("click",async e=>{e.preventDefault(),await F()});async function F(){const e=y.files[0];if(!e){alert("Please upload an image. Image is required for found items.");return}const o=document.getElementById("foundItemName").value.trim(),i=document.getElementById("foundItemType").value,u=document.getElementById("foundLocationFound").value.trim(),t=document.getElementById("foundDateFound").value;if(!o||!i||!u||!t){alert("Please fill in all required fields (Item Name, Type, Location Found, Date Found).");return}if(t>L){alert("The found date cannot be in the future.");return}if(e.size>5*1024*1024){alert("Image size must be less than 5MB.");return}m.disabled=!0,m.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i>Uploading...';let d=null,l=null;try{const r=e.name.split(".").pop(),g=`found_items/${`${Date.now()}_${Math.random().toString(36).substring(7)}.${r}`}`;l=g;const{data:n,error:s}=await a.storage.from("lost_found_images").upload(g,e);if(s)throw new Error(`Image upload failed: ${s.message}`);const{data:{publicUrl:D}}=a.storage.from("lost_found_images").getPublicUrl(g),P={admin_id:p.user.id,item_name:o,item_type:i,brand:document.getElementById("foundBrand").value.trim()||null,model:document.getElementById("foundModel").value.trim()||null,primary_color:document.getElementById("foundPrimaryColor").value.trim()||null,secondary_color:document.getElementById("foundSecondaryColor").value.trim()||null,serial_number:document.getElementById("foundSerialNumber").value.trim()||null,distinguishing_features:document.getElementById("foundDistinguishingFeatures").value.trim()||null,description:document.getElementById("foundDescription").value.trim()||null,location_found:u,date_found:t,time_found:document.getElementById("foundTimeFound").value||null,status:"Unclaimed"},{data:E,error:v}=await a.from("found_items").insert([P]).select().single();if(v)throw new Error(`Database insert failed: ${v.message}`);d=E.found_item_id;const{error:w}=await a.from("lost_found_attachments").insert([{found_item_id:E.found_item_id,file_url:D,file_type:"image"}]);if(w)throw new Error(`Attachment insert failed: ${w.message}`);alert("Found item uploaded successfully!"),window.location.href="AdminLostFound.html?tab=found"}catch(r){console.error("Error uploading found item:",r),alert(`Failed to upload found item: ${r.message}`),d&&await a.from("found_items").delete().eq("found_item_id",d),l&&await a.storage.from("lost_found_images").remove([l]),m.disabled=!1,m.innerHTML='<i class="fas fa-check-circle"></i>Confirm & Upload Item'}}function M(){const e=document.getElementById("profileButton"),o=document.getElementById("profileMenu"),i=document.getElementById("logoutModal"),u=document.getElementById("confirmLogoutBtn"),t=document.getElementById("cancelLogoutBtn"),d=document.getElementById("headerLogoutBtn"),l=document.getElementById("mobileMenuButton"),r=document.getElementById("mobileMenu"),f=document.getElementById("overlay");if(e&&o){const n=e.cloneNode(!0);e.parentNode.replaceChild(n,e),n.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),o.classList.toggle("hidden")}),document.addEventListener("click",s=>{!n.contains(s.target)&&!o.contains(s.target)&&o.classList.add("hidden")})}const g=n=>{n&&n.preventDefault(),o&&o.classList.add("hidden"),i&&i.classList.remove("hidden")};if(d){const n=d.cloneNode(!0);d.parentNode.replaceChild(n,d),n.addEventListener("click",g)}if(t&&(t.onclick=()=>i.classList.add("hidden")),u&&(u.onclick=async()=>{await a.auth.signOut(),window.location.href="Login.html"}),l&&r&&f){const n=l.cloneNode(!0);l.parentNode.replaceChild(n,l),n.onclick=()=>{r.classList.toggle("-translate-x-full"),f.classList.toggle("hidden")},f.onclick=()=>{r.classList.add("-translate-x-full"),f.classList.add("hidden")}}}});
