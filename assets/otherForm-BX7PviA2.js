import{s as o}from"./darkMode-B-Ivf8oh.js";document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:u}}=await o.auth.getSession();if(!u||!u.user){window.location.href="Login.html";return}const I=document.getElementById("otherComplaintForm"),l=document.getElementById("dateIncident"),c=document.getElementById("description"),f=document.getElementById("fileDesc"),p=document.getElementById("previousAttempt"),F=document.getElementById("declaration"),T=document.getElementById("desiredOutcome"),x=document.getElementById("category"),C=document.getElementById("descCounter"),b=document.getElementById("fileCounter"),D=document.getElementById("attemptCounter"),$=new Date().toISOString().split("T")[0];l.setAttribute("max",$);function _(e){return e.trim().split(/\s+/).filter(Boolean).length}function g(e,t,n){e.addEventListener("input",()=>{let r=_(e.value);r>n&&(e.value=e.value.split(/\s+/).slice(0,n).join(" "),r=n),t.textContent=`${r} / ${n} words`})}const d=document.getElementById("file"),h=document.getElementById("imagePreview");d.addEventListener("change",()=>{h.innerHTML="",d.files&&Array.from(d.files).forEach(e=>{if(e.type.startsWith("image/")){const t=new FileReader;t.onload=n=>{const r=document.createElement("div");r.classList.add("relative","w-24","h-24");const i=document.createElement("img");i.src=n.target.result,i.classList.add("w-full","h-full","object-cover","rounded-lg","border","border-gray-200","shadow-sm");const a=document.createElement("button");a.innerHTML='<i class="fas fa-times"></i>',a.classList.add("absolute","-top-2","-right-2","bg-red-500","text-white","rounded-full","w-6","h-6","flex","items-center","justify-center","text-xs","hover:bg-red-600","shadow-md"),a.onclick=m=>{m.preventDefault(),d.value="",h.innerHTML=""},r.appendChild(i),r.appendChild(a),h.appendChild(r)},t.readAsDataURL(e)}})}),g(c,C,500),g(f,b,100),g(p,D,100),[c,f,p].forEach(e=>{e&&e.dispatchEvent(new Event("input"))});let y=u;if(!y||!y.user){window.location.href="Login.html";return}const j=y.user.id;I.addEventListener("submit",async e=>{e.preventDefault();let t=[];const n=document.getElementById("complaintTitle").value.trim();n?/^[A-Za-z0-9\s]+$/.test(n)||t.push("Complaint title can only contain letters, numbers, and spaces."):t.push("Complaint title is required.");const r=new Date().toISOString().split("T")[0];if(l.value?l.value>r&&t.push("Date of Incident cannot be in the future."):t.push("Please select the Date of Incident."),c.value.trim()||t.push("Description is required."),F.checked||t.push("You must declare that the information is accurate."),t.length>0){alert(t.join(`
`));return}try{const{data:i,error:a}=await o.from("admin").select("id").eq("adminrole","General Admin").single();if(a||!i){console.error("Error fetching General Admin:",a),alert("System Error: Could not find General Admin. Please contact support.");return}const m=i.id,{data:B,error:L}=await o.from("category").select("categoryid").eq("categoryname","Other").single();if(L||!B){console.error("Error fetching Other category:",L),alert("System Error: Could not find Other category. Please contact support.");return}const q=B.categoryid,{data:M,error:P}=await o.from("complaint").insert([{complainantid:j,adminid:m,categoryid:q,submitteddate:new Date().toISOString(),dateofincident:l.value,complainttitle:n,complaintdescription:c.value.trim(),complaintstatus:"Pending"}]).select().single();if(P){console.error("Complaint insert error:",P),alert("Failed to submit complaint. Please try again.");return}const E=M.complaintid,{error:A}=await o.from("othercomplaint").insert([{complaintid:E,previousattempts:p.value.trim()||null,suggestedcategory:x.value.trim()||null,desiredoutcome:T.value.trim()||null}]);if(A){console.error("Other complaint insert error:",A),alert("Failed to save other complaint. Please try again.");return}const w=document.getElementById("file"),U=f.value.trim();if(w.files.length>0)for(let s=0;s<w.files.length;s++){const v=w.files[s],G=`${Date.now()}_${v.name}`,{data:H,error:O}=await o.storage.from("user-uploads").upload(G,v);if(O){console.error("File upload error:",O),alert("File upload failed. Please try again.");return}const{data:N}=o.storage.from("user-uploads").getPublicUrl(H.path),k=N.publicUrl,{error:S}=await o.from("complaintattachment").insert([{complaintid:E,fileurl:k,description:U,filename:v.name}]);if(S){console.error("Attachment insert error:",S),alert("Failed to save file info. Please try again.");return}}try{await o.from("admin_notifications").insert([{admin_id:m,complaint_id:E,type:"New Complaint",message:`New complaint submitted: "${n}"`,is_read:!1}])}catch(s){console.error("Failed to create admin notification:",s)}I.reset(),C.textContent="0 / 500 words",b.textContent="0 / 100 words",D.textContent="0 / 100 words",alert("Other complaint submitted successfully!")}catch(i){console.error(i),alert("Something went wrong. Please try again.")}})});
